#!/bin/bash

set -e  # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰å³åº§ã«çµ‚äº†

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åŸºæº–ã«gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã‚’å–å¾—
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    PROJECT_ROOT="$(git rev-parse --show-toplevel)"
else
    PROJECT_ROOT="$(dirname "${BASH_SOURCE[0]}")"
fi

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’å–å¾—ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’æ§‹ç¯‰
CURRENT_DIR_NAME="$(basename "$PROJECT_ROOT")"
IMAGE_NAME="vibebox/${CURRENT_DIR_NAME}"
TAG="${VIVEBOX_TAG:-latest}"
BUILD_CONTEXT="$PROJECT_ROOT/.vibebox"
DOCKERFILE_PATH="$PROJECT_ROOT/.vibebox/Dockerfile"
DEFAULT_CONTAINER_USERNAME="${VIBEBOX_CONTAINER_USERNAME:-vibebox}"

if command -v envchain >/dev/null 2>&1; then
    HAS_ENVCHAIN="true"
else
    HAS_ENVCHAIN="false"
fi

docker_cmd() {
    if [[ "$HAS_ENVCHAIN" == "true" ]]; then
        envchain "$IMAGE_NAME" docker "$@"
    else
        docker "$@"
    fi
}

docker_cmd_prefix() {
    if [[ "$HAS_ENVCHAIN" == "true" ]]; then
        printf 'envchain %q docker' "$IMAGE_NAME"
    else
        printf 'docker'
    fi
}

docker_find_running_container_id_by_name() {
    local expected_container_name="$1"
    if [[ -z "$expected_container_name" ]]; then
        return 1
    fi

    local running_containers
    running_containers=$(docker_cmd ps --filter "name=vibebox" --format "{{.ID}}\t{{.Names}}" 2>/dev/null || true)
    if [[ -z "$running_containers" ]]; then
        return 1
    fi

    while IFS=$'\t' read -r container_id container_name; do
        if [[ -n "$container_id" && "$container_name" == "$expected_container_name" ]]; then
            printf '%s\n' "$container_id"
            return 0
        fi
    done <<< "$running_containers"

    return 1
}

devcontainer_cmd() {
    if ! command -v devcontainer &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: devcontainer CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
        return 1
    fi

    if [[ "$HAS_ENVCHAIN" == "true" ]]; then
        envchain "$IMAGE_NAME" devcontainer "$@"
    else
        devcontainer "$@"
    fi
}

devcontainer_cmd_prefix() {
    if [[ "$HAS_ENVCHAIN" == "true" ]]; then
        printf 'envchain %q devcontainer' "$IMAGE_NAME"
    else
        printf 'devcontainer'
    fi
}

# AWSé–¢é€£ã®ç’°å¢ƒå¤‰æ•°ãƒªã‚¹ãƒˆ
AWS_ENV_VARS=(
    "AWS_ACCESS_KEY_ID"
    "AWS_SECRET_ACCESS_KEY"
    "AWS_SESSION_TOKEN"
    "AWS_DEFAULT_REGION"
    "AWS_REGION"
    "AWS_PROFILE"
    "AWS_CONFIG_FILE"
    "AWS_SHARED_CREDENTIALS_FILE"
)

resolve_vibebox_ecr_registry() {
    printf '%s' "${VIBEBOX_ECR_REGISTRY:-}"
}

resolve_vibebox_aws_region() {
    if [[ -n "${VIBEBOX_AWS_REGION:-}" ]]; then
        printf '%s' "$VIBEBOX_AWS_REGION"
    elif [[ -n "${AWS_REGION:-}" ]]; then
        printf '%s' "$AWS_REGION"
    elif [[ -n "${AWS_DEFAULT_REGION:-}" ]]; then
        printf '%s' "$AWS_DEFAULT_REGION"
    fi
}

escape_sed_replacement() {
    printf '%s' "$1" | sed -e 's/[\/&|]/\\&/g'
}

# ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…ã®å ´åˆã€ãƒ–ãƒ©ãƒ³ãƒåã‚’è‡ªå‹•å–å¾—
get_current_branch_name() {
    if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        # cloneå½¢å¼ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã©ã†ã‹ã‚’åˆ¤å®š
        local current_dir
        current_dir="$(pwd)"
        local vibebox_workspace_base="$PROJECT_ROOT/.vibebox-workspaces"

        # vibebox-workspacesé…ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ãƒã‚§ãƒƒã‚¯
        if [[ "$current_dir" == "$vibebox_workspace_base"* ]]; then
            # vibebox-workspaces/{branch-name} ã®éƒ¨åˆ†ã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒåã‚’æŠ½å‡º
            local relative_path="${current_dir#$vibebox_workspace_base/}"
            # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã„ã‚‹å ´åˆã¯æœ€åˆã®éƒ¨åˆ†ãŒãƒ–ãƒ©ãƒ³ãƒå
            echo "${relative_path%%/*}"
            return 0
        fi
    fi
    return 1
}

# devcontainerã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°
find_devcontainer() {
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")

    # devcontainer.{repo-name} ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’æ¤œç´¢
    local container_id
    container_id=$(docker_cmd ps --filter "name=vibebox.${git_repo_name}" --format "{{.ID}}" 2>/dev/null | head -1)

    if [[ -n "$container_id" ]]; then
        echo "$container_id"
        return 0
    fi

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: devcontainerã§å§‹ã¾ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’æ¤œç´¢
    container_id=$(docker_cmd ps --filter "name=vibebox." --format "{{.ID}}" 2>/dev/null | head -1)

    if [[ -n "$container_id" ]]; then
        echo "$container_id"
        return 0
    fi

    return 1
}

# devcontainer.jsonã‹ã‚‰workspaceFolderã‚’å–å¾—ã™ã‚‹é–¢æ•°
get_devcontainer_workspace_folder() {
    local devcontainer_json="$PROJECT_ROOT/.devcontainer/devcontainer.json"

    # devcontainer.jsonãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -f "$devcontainer_json" ]]; then
        echo '\$HOME'
        return 0
    fi

    # workspaceFolderã‚’å–å¾—
    local workspace_folder

    # jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if command -v jq &> /dev/null; then
        workspace_folder=$(sed 's://.*$::g; s:/\*.*\*/::g' "$devcontainer_json" | jq -r '.workspaceFolder // empty' 2>/dev/null)
    else
        # jqãŒãªã„å ´åˆã¯grepã¨sedã§æŠ½å‡º
        workspace_folder=$(grep -o '"workspaceFolder"[[:space:]]*:[[:space:]]*"[^"]*"' "$devcontainer_json" 2>/dev/null | sed 's/.*"workspaceFolder"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
    fi

    # workspaceFolderãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    if [[ -z "$workspace_folder" || "$workspace_folder" == "null" ]]; then
        echo '\$HOME'
    else
        echo "$workspace_folder"
    fi
}

# ä¸ãˆã‚‰ã‚ŒãŸãƒ‘ã‚¹ï¼ˆã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å«ã‚€ï¼‰ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«è§£æ±ºã™ã‚‹
resolve_absolute_path() {
    local path="$1"

    while [[ -L "$path" ]]; do
        local target
        target="$(readlink "$path")"

        if [[ "$target" == /* ]]; then
            path="$target"
        else
            path="$(cd "$(dirname "$path")" && pwd -P)/$target"
        fi
    done

    path="$(cd "$(dirname "$path")" && pwd -P)/$(basename "$path")"
    printf '%s\n' "$path"
}

# ~/.local/bin/vibebox ã«ç¾åœ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¸ã®symlinkã‚’ä½œæˆã™ã‚‹
link_vibebox_command() {
    local script_path
    script_path="$(resolve_absolute_path "${BASH_SOURCE[0]}")"

    local link_dir="$HOME/.local/bin"
    local link_path="$link_dir/vibebox"

    mkdir -p "$link_dir"

    if [[ -L "$link_path" ]]; then
        local existing_target
        existing_target="$(resolve_absolute_path "$link_path")"

        if [[ "$existing_target" == "$script_path" ]]; then
            echo "æ—¢ã«è¨­å®šæ¸ˆã¿ã§ã™: $link_path -> $script_path"
            return 0
        fi

        ln -sfn "$script_path" "$link_path"
        echo "symlinkã‚’æ›´æ–°ã—ã¾ã—ãŸ: $link_path -> $script_path"
    elif [[ -e "$link_path" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: $link_path ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆsymlinkã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰" >&2
        echo "æ‰‹å‹•ã§å‰Šé™¤ã¾ãŸã¯ãƒªãƒãƒ¼ãƒ ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
        return 1
    else
        ln -s "$script_path" "$link_path"
        echo "symlinkã‚’ä½œæˆã—ã¾ã—ãŸ: $link_path -> $script_path"
    fi

    case ":$PATH:" in
        *":$link_dir:"*)
            ;;
        *)
            echo
            echo "æ³¨æ„: $link_dir ãŒ PATH ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            echo "å¿…è¦ã«å¿œã˜ã¦ã‚·ã‚§ãƒ«è¨­å®šã«æ¬¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„:"
            echo "  export PATH=\"$link_dir:\$PATH\""
            ;;
    esac
}

# ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤º
show_usage() {
    cat << EOF
Usage: $0 <command> [options]

â–  ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    init                       .vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆæœŸåŒ–ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ï¼‰
    container build [--tag TAG] [--build-arg KEY=VALUE] [--no-cache]
                               .vibebox/Dockerfileã‚’ä½¿ã£ã¦vibeboxã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
    container tag [--tag TAG]   ãƒ­ãƒ¼ã‚«ãƒ«ã®vibeboxã‚¤ãƒ¡ãƒ¼ã‚¸ã«ECRã‚¿ã‚°ã‚’ä»˜ä¸ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
    container push [--tag TAG] ECRã«vibeboxã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
    doctor                     vibeboxç’°å¢ƒã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯

â–  ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡
    list | ls                  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆ`ws ls` ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
    up <branch-name> [--no-attach]
                               æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã§vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’è‡ªå‹•ä½œæˆï¼‰
                               devcontainer.jsonã®runArgsã«ãƒ–ãƒ©ãƒ³ãƒåã‚’è¿½åŠ ã—ã¦èµ·å‹•
    down [branch-name] [--rm]
                               æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ï¼ˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã¯çœç•¥å¯ï¼‰
                               --rm ã‚’æŒ‡å®šã™ã‚‹ã¨åœæ­¢å¾Œã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    down --all [--rm]          ã™ã¹ã¦ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ï¼ˆ--rmæŒ‡å®šæ™‚ã¯ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚‚å‰Šé™¤ï¼‰

â–  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
    shell [branch-name]        æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã§ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ï¼ˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã¯çœç•¥å¯ï¼‰
    edit [branch-name]         æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’Cursorã§é–‹ãï¼ˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã¯çœç•¥å¯ï¼‰
    attach [branch-name]       tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒï¼ˆãƒ–ãƒ©ãƒ³ãƒåæŒ‡å®šã§ç‰¹å®šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¸ï¼‰
    cd [branch-name]           ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãï¼ˆwindowå: {branch-name}(local)ï¼‰

â–  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç®¡ç†
    workspace list             .vibebox-workspaceså†…ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ã‚’è¡¨ç¤º
    ws ls                      workspace listã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
    rm [branch-name]           æŒ‡å®šãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ‰ã‚Šï¼‰

â–  ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
    cleanup                    ã™ã¹ã¦ã®vibeboxãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤

â–  ãã®ä»–
    help                       ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
    link                       ~/.local/bin/vibebox ã¸ã®symlinkã‚’ä½œæˆ
    secrets set               envchainã‚’ä½¿ã£ã¦AWSã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®š

Options:
    --attach                   ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¾Œã«tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è‡ªå‹•ã‚¢ã‚¿ãƒƒãƒ (upã®ã¿)
    --all                      ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¯¾è±¡ã«ã™ã‚‹ (downã®ã¿)
    --rm                       ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢å¾Œã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ (downã®ã¿)
    --tag TAG                  Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’æŒ‡å®š (container build/pushã®ã¿)
    --build-arg KEY=VALUE      Dockerãƒ“ãƒ«ãƒ‰å¼•æ•°ã‚’æŒ‡å®š (container buildã®ã¿)
    --no-cache                 Dockerãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„ (container buildã®ã¿)

Requirements:
    - devcontainer CLI: npm install -g @devcontainers/cli
    - jq: JSONã®è§£æã«å¿…è¦
    - tmux: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«æ¨å¥¨

Environment Variables (optional):
    - VIBEBOX_ECR_REGISTRY        ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒª (ä¾‹: 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com)
    - VIBEBOX_AWS_REGION          ECRãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
    - VIBEBOX_S3_DEV_BUCKET_NAME  Docker buildæ™‚ã«æ¸¡ã™ä»»æ„ãƒ“ãƒ«ãƒ‰å¼•æ•°
    - VIBEBOX_DEVCONTAINER_IMAGE  initæ™‚ã«ç”Ÿæˆã™ã‚‹devcontainer image
    - VIBEBOX_ENVCHAIN_SERVICE    initæ™‚ã«ç”Ÿæˆã™ã‚‹envchainã‚µãƒ¼ãƒ“ã‚¹å
    - VIBEBOX_CONTAINER_USERNAME  initæ™‚ã«ç”Ÿæˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãƒ¦ãƒ¼ã‚¶ãƒ¼å
EOF
}

# ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰
build_image() {
    local tag="$1"
    local use_aws_env="$2"
    local no_cache="$3"
    shift 3
    local custom_build_args=("$@")

    echo "=== vibebox Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­ ==="
    echo "ã‚¤ãƒ¡ãƒ¼ã‚¸å: ${IMAGE_NAME}:${tag}"
    echo "ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: $BUILD_CONTEXT"
    echo "Dockerfile: $DOCKERFILE_PATH"
    echo

    # Dockerfileã®å­˜åœ¨ç¢ºèª
    if [[ ! -f "$DOCKERFILE_PATH" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: DockerfileãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $DOCKERFILE_PATH" >&2
        exit 1
    fi

    # ãƒ“ãƒ«ãƒ‰å¼•æ•°ã‚’æ§‹ç¯‰
    local build_args=()

    # ä»»æ„ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ“ãƒ«ãƒ‰å¼•æ•°ã‚’è¿½åŠ 
    local default_s3_bucket="${VIBEBOX_S3_DEV_BUCKET_NAME:-}"
    if [[ -n "$default_s3_bucket" ]]; then
        build_args+=(--build-arg "VIBEBOX_S3_DEV_BUCKET_NAME=${default_s3_bucket}")
    fi

    # ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ«ãƒ‰å¼•æ•°ã‚’è¿½åŠ 
    build_args+=("${custom_build_args[@]}")

    # Docker buildã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
    echo "Docker buildã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­..."
    if [[ ${#build_args[@]} -gt 0 ]]; then
        echo "ãƒ“ãƒ«ãƒ‰å¼•æ•°:"
        for arg in "${build_args[@]}"; do
            if [[ "$arg" == "--build-arg" ]]; then
                continue
            fi
            # ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªæƒ…å ±ã‚’ãƒã‚¹ã‚¯
            if [[ "$arg" =~ AWS_ACCESS_KEY_ID=.* ]] || [[ "$arg" =~ AWS_SECRET_ACCESS_KEY=.* ]] || [[ "$arg" =~ AWS_SESSION_TOKEN=.* ]]; then
                echo "  ${arg%%=*}=***"
            else
                echo "  $arg"
            fi
        done
        echo
    fi

    # --no-cacheã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å‡¦ç†
    local cache_option=()
    if [[ "$no_cache" == "true" ]]; then
        cache_option=(--no-cache)
        echo "æ³¨æ„: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã›ãšã«ãƒ“ãƒ«ãƒ‰ã—ã¾ã™"
        echo
    fi

    docker_cmd build \
        --secret id=aws_access_key_id,env=AWS_ACCESS_KEY_ID \
        --secret id=aws_secret_access_key,env=AWS_SECRET_ACCESS_KEY \
        --file "$DOCKERFILE_PATH" \
        --tag "${IMAGE_NAME}:${tag}" \
        --progress=plain \
        "${cache_option[@]}" \
        "${build_args[@]}" \
        "$BUILD_CONTEXT"

    echo
    echo "=== ãƒ“ãƒ«ãƒ‰å®Œäº† ==="
    echo "ã‚¤ãƒ¡ãƒ¼ã‚¸: ${IMAGE_NAME}:${tag}"
    echo
    local docker_prefix
    docker_prefix=$(docker_cmd_prefix)
    echo "æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã§ãã¾ã™:"
    echo "  ${docker_prefix} run -it --rm ${IMAGE_NAME}:${tag} bash"
}

# ECRã‚¿ã‚°ä»˜ä¸å‡¦ç†
tag_image_core() {
    local tag="$1"
    local quiet="${2:-false}"

    local ecr_registry
    ecr_registry=$(resolve_vibebox_ecr_registry)
    if [[ -z "$ecr_registry" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: VIBEBOX_ECR_REGISTRY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
        echo "ä¾‹: export VIBEBOX_ECR_REGISTRY=123456789012.dkr.ecr.ap-northeast-1.amazonaws.com" >&2
        return 1
    fi
    local ecr_repository="${IMAGE_NAME}"
    local ecr_image="${ecr_registry}/${ecr_repository}:${tag}"

    if [[ "$quiet" != "true" ]]; then
        echo "=== vibebox Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ECRã‚¿ã‚°ã‚’ä»˜ä¸ ==="
        echo "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸: ${IMAGE_NAME}:${tag}"
        echo "ECRã‚¤ãƒ¡ãƒ¼ã‚¸: ${ecr_image}"
        echo
    fi

    if ! docker_cmd image inspect "${IMAGE_NAME}:${tag}" >/dev/null 2>&1; then
        echo "ã‚¨ãƒ©ãƒ¼: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${IMAGE_NAME}:${tag}" >&2
        echo "ã¾ãš 'container build' ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚" >&2
        return 1
    fi

    if [[ "$quiet" != "true" ]]; then
        echo "ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ECRã‚¿ã‚°ã‚’ä»˜ã‘ã¦ã„ã¾ã™..."
    fi

    if ! docker_cmd tag "${IMAGE_NAME}:${tag}" "${ecr_image}"; then
        echo "ã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
        return 1
    fi

    if [[ "$quiet" != "true" ]]; then
        echo "âœ“ ã‚¿ã‚°ä»˜ã‘å®Œäº†: ${ecr_image}"
        echo
        echo "ã‚¿ã‚°ä»˜ã‘ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã«ã¯:"
        echo "  docker push ${ecr_image}"
    else
        printf "%s" "$ecr_image"
    fi
}

tag_image() {
    local tag="$1"
    tag_image_core "$tag"
}

# container tagã‚³ãƒãƒ³ãƒ‰
container_tag_command() {
    local custom_tag=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --tag)
                custom_tag="$2"
                shift 2
                ;;
            --help|-h)
                show_usage
                exit 0
                ;;
            *)
                echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                show_usage
                exit 1
                ;;
        esac
    done

    if [[ -n "$custom_tag" ]]; then
        TAG="$custom_tag"
    fi

    tag_image "$TAG"
}

# pushã‚³ãƒãƒ³ãƒ‰
push_image() {
    local tag="$1"
    local ecr_registry
    ecr_registry=$(resolve_vibebox_ecr_registry)
    if [[ -z "$ecr_registry" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: VIBEBOX_ECR_REGISTRY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
        echo "ä¾‹: export VIBEBOX_ECR_REGISTRY=123456789012.dkr.ecr.ap-northeast-1.amazonaws.com" >&2
        exit 1
    fi

    local aws_region
    aws_region=$(resolve_vibebox_aws_region)
    if [[ -z "$aws_region" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
        echo "VIBEBOX_AWS_REGION ã¾ãŸã¯ AWS_REGION ã‚’è¨­å®šã—ã¦ãã ã•ã„" >&2
        exit 1
    fi

    local ecr_repository="${IMAGE_NAME}"

    echo "=== vibebox Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã«ãƒ—ãƒƒã‚·ãƒ¥ ==="
    echo "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸: ${IMAGE_NAME}:${tag}"
    echo "ECRã‚¤ãƒ¡ãƒ¼ã‚¸: ${ecr_registry}/${ecr_repository}:${tag}"
    echo

    # ECRã«ãƒ­ã‚°ã‚¤ãƒ³
    echo "ECRã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­..."
    if ! aws ecr get-login-password --region "$aws_region" | docker_cmd login --username AWS --password-stdin "${ecr_registry}" 2>/dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
        echo "AWSèªè¨¼æƒ…å ±ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >&2
        exit 1
    fi
    echo "âœ“ ECRã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ"
    echo

    echo "ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ECRã‚¿ã‚°ã‚’ä»˜ã‘ã¦ã„ã¾ã™..."
    local tagged_ecr_image
    if ! tagged_ecr_image=$(tag_image_core "$tag" "true"); then
        exit 1
    fi
    echo "âœ“ ã‚¿ã‚°ä»˜ã‘å®Œäº†: ${tagged_ecr_image}"
    echo

    # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
    echo "ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
    if ! docker_cmd push "${tagged_ecr_image}"; then
        echo "ã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
        exit 1
    fi

    echo
    echo "=== ãƒ—ãƒƒã‚·ãƒ¥å®Œäº† ==="
    echo "ECRã‚¤ãƒ¡ãƒ¼ã‚¸: ${tagged_ecr_image}"
    echo
    echo "ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯:"
    echo "  docker pull ${tagged_ecr_image}"
}

# ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤ãƒ˜ãƒ«ãƒ‘ãƒ¼
remove_workspace_directory() {
    local branch_name="$1"

    if [[ -z "$branch_name" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤ã®ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
        return 1
    fi

    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"

    if [[ ! -d "$workspace_path" ]]; then
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯å­˜åœ¨ã—ã¾ã›ã‚“: $workspace_path"
        return 0
    fi

    echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™: $workspace_path"
    if rm -rf "$workspace_path"; then
        echo "âœ“ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        rmdir -p "$(dirname "$workspace_path")" 2>/dev/null || true

        local vibebox_dir="$PROJECT_ROOT/.vibebox-workspaces"
        if [[ -d "$vibebox_dir" ]] && [[ -z "$(ls -A "$vibebox_dir" 2>/dev/null)" ]]; then
            rmdir "$vibebox_dir" 2>/dev/null || true
        fi
    else
        echo "âœ— ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
        return 1
    fi

    return 0
}

remove_all_workspaces() {
    local vibebox_dir="$PROJECT_ROOT/.vibebox-workspaces"

    if [[ ! -d "$vibebox_dir" ]]; then
        echo "å‰Šé™¤å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“: $vibebox_dir"
        return 0
    fi

    shopt -s nullglob
    local workspace_paths=("$vibebox_dir"/*)
    shopt -u nullglob

    if [[ ${#workspace_paths[@]} -eq 0 ]]; then
        echo "å‰Šé™¤å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
        return 0
    fi

    for workspace_path in "${workspace_paths[@]}"; do
        if [[ -d "$workspace_path" ]]; then
            local branch_name="${workspace_path#$vibebox_dir/}"
            remove_workspace_directory "$branch_name"
        fi
    done

    return 0
}

# stopã‚³ãƒãƒ³ãƒ‰ï¼ˆ--allç”¨ï¼‰
stop_all_sessions() {
    local remove_workspace_flag="${1:-false}"

    echo "=== ã™ã¹ã¦ã® devcontainer ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ ==="
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªåã‚’å–å¾—
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")

    # ç¨¼åƒä¸­ã®devcontainerã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
    local container_ids
    container_ids=$(docker_cmd ps --filter "name=vibebox.${git_repo_name}" --format "{{.ID}}" 2>/dev/null)

    if [[ -z "$container_ids" ]]; then
        echo "ç¾åœ¨ç¨¼åƒä¸­ã®devcontainerã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
    else
        echo "ã™ã¹ã¦ã®devcontainerã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™..."
        echo

        local count=0
        local stopped_branch_names=()

        while IFS= read -r container_id; do
            if [[ -n "$container_id" ]]; then
                count=$((count + 1))
                # ã‚³ãƒ³ãƒ†ãƒŠåã‚’å–å¾—
                local container_name
                container_name=$(docker_cmd inspect "$container_id" --format '{{.Name}}' 2>/dev/null | sed 's/^\/*//')
                echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ $container_name ã‚’åœæ­¢ä¸­..."

                # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’ç‰¹å®šã—ã¦devcontainer downã‚’è©¦è¡Œ
                if [[ "$container_name" =~ devcontainer\.${git_repo_name}\.(.+)$ ]]; then
                    local branch_name="${BASH_REMATCH[1]}"
                    # ãƒã‚¤ãƒ•ãƒ³ã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«æˆ»ã™
                    branch_name="${branch_name//-/\/}"
                    stopped_branch_names+=("$branch_name")
                    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"

                    if command -v devcontainer &> /dev/null && [[ -d "$workspace_path" ]]; then
                if devcontainer_cmd down --workspace-folder "$workspace_path" >/dev/null 2>&1; then
                            echo "  âœ“ åœæ­¢å®Œäº† (devcontainer down)"
                        else
                            # devcontainer downãŒå¤±æ•—ã—ãŸå ´åˆã¯ç›´æ¥åœæ­¢
                            docker_cmd stop "$container_id" >/dev/null 2>&1
                            if [[ $? -eq 0 ]]; then
                                docker_cmd rm "$container_id" >/dev/null 2>&1
                                if [[ $? -eq 0 ]]; then
                                    echo "  âœ“ åœæ­¢ãƒ»å‰Šé™¤å®Œäº† (docker stop & rm)"
                                else
                                    echo "  âœ“ åœæ­¢å®Œäº†ã€å‰Šé™¤å¤±æ•— (docker stop)"
                                fi
                            else
                                echo "  âœ— åœæ­¢å¤±æ•—"
                            fi
                        fi
                else
                        # devcontainer CLIãŒãªã„å ´åˆã¯ç›´æ¥åœæ­¢
                        docker_cmd stop "$container_id" >/dev/null 2>&1
                        if [[ $? -eq 0 ]]; then
                            docker_cmd rm "$container_id" >/dev/null 2>&1
                            if [[ $? -eq 0 ]]; then
                                echo "  âœ“ åœæ­¢ãƒ»å‰Šé™¤å®Œäº†"
                            else
                                echo "  âœ“ åœæ­¢å®Œäº†ã€å‰Šé™¤å¤±æ•—"
                            fi
                        else
                            echo "  âœ— åœæ­¢å¤±æ•—"
                        fi
                    fi
                else
                    # åå‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä¸€è‡´ã—ãªã„å ´åˆã‚‚åœæ­¢ã‚’è©¦è¡Œ
                    docker_cmd stop "$container_id" >/dev/null 2>&1
                    if [[ $? -eq 0 ]]; then
                        docker_cmd rm "$container_id" >/dev/null 2>&1
                        if [[ $? -eq 0 ]]; then
                            echo "  âœ“ åœæ­¢ãƒ»å‰Šé™¤å®Œäº†"
                        else
                            echo "  âœ“ åœæ­¢å®Œäº†ã€å‰Šé™¤å¤±æ•—"
                        fi
                    else
                        echo "  âœ— åœæ­¢å¤±æ•—"
                    fi
                fi
            fi
        done <<< "$container_ids"

        if [[ $count -eq 0 ]]; then
            echo "åœæ­¢å¯¾è±¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        else
            echo
            echo "$count å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚"
        fi

        if [[ "$remove_workspace_flag" == "true" ]]; then
            echo
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚"
            if [[ ${#stopped_branch_names[@]} -gt 0 ]]; then
                for branch_name in "${stopped_branch_names[@]}"; do
                    remove_workspace_directory "$branch_name" || true
                done
            fi
        fi
    fi

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å‰Šé™¤
    if command -v tmux &> /dev/null; then
        local tmux_session="vibebox_${git_repo_name//[.\/-]/_}"

        if tmux has-session -t "$tmux_session" 2>/dev/null; then
            echo
            echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™: $tmux_session"
            tmux kill-session -t "$tmux_session" 2>/dev/null
            if [[ $? -eq 0 ]]; then
                echo "âœ“ tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"
            else
                echo "âœ— tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            fi
        fi
    fi
    if [[ "$remove_workspace_flag" == "true" ]]; then
        echo
        echo "æ®‹ã‚Šã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
        remove_all_workspaces
    fi
}

# stopã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ–ãƒ©ãƒ³ãƒåãƒ™ãƒ¼ã‚¹ï¼‰
stop_session() {
    local branch_name="$1"
    local remove_workspace_flag="${2:-false}"

    # ãƒ–ãƒ©ãƒ³ãƒåãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
    if [[ -z "$branch_name" ]]; then
        branch_name=$(get_current_branch_name)
        if [[ -z "$branch_name" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒ–ãƒ©ãƒ³ãƒåã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„" >&2
            exit 1
        fi
        echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒå: $branch_name"
    fi

    echo "=== vibebox ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ ==="
    echo "ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æ§‹ç¯‰
    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã‚’æ§‹ç¯‰
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")
    local tmux_session="${git_repo_name//[.\/-]/_}/vibebox"
    local tmux_window="${branch_name//[\/.-]/_}"

    # ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒåï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›ï¼‰
    local sanitized_branch="${branch_name//\//-}"
    local expected_container_name="vibebox.${git_repo_name}.${sanitized_branch}"

    # ã‚³ãƒ³ãƒ†ãƒŠIDã‚’æ¤œç´¢
    local container_id=""
    container_id="$(docker_find_running_container_id_by_name "$expected_container_name" || true)"

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
    if [[ -z "$container_id" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo
        echo "ç¨¼åƒä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§:"
        list_sessions
        exit 1
    fi

    echo "ã‚³ãƒ³ãƒ†ãƒŠå: $expected_container_name"
    echo "ã‚³ãƒ³ãƒ†ãƒŠID: $container_id"

    # devcontainer CLIã«ã¯åœæ­¢ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒç„¡ã„ãŸã‚ã€ç›´æ¥Dockerã§åœæ­¢
    echo "Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
    docker_cmd stop "$container_id" >/dev/null 2>&1
    if [[ $? -eq 0 ]]; then
        echo "âœ“ ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¾ã—ãŸã€‚"

        # ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
        echo "Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ä¸­..."
        docker_cmd rm "$container_id" >/dev/null 2>&1
        if [[ $? -eq 0 ]]; then
            echo "âœ“ ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"
        else
            echo "âœ— ã‚³ãƒ³ãƒ†ãƒŠã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        fi
    else
        echo "âœ— ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        exit 1
    fi

    # tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç¢ºèªã—ã¦é–‰ã˜ã‚‹
    if command -v tmux &> /dev/null && tmux has-session -t "$tmux_session" 2>/dev/null; then
        if tmux list-windows -t "$tmux_session" -F "#{window_name}" | grep -q "^${tmux_window}$"; then
            echo "tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¾ã™: $tmux_session:$tmux_window"
            tmux kill-window -t "$tmux_session:$tmux_window" 2>/dev/null || true
        fi
    fi

    if [[ "$remove_workspace_flag" == "true" ]]; then
        echo
        echo "--rm ãŒæŒ‡å®šã•ã‚ŒãŸãŸã‚ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™..."
        if ! remove_workspace_directory "$branch_name"; then
            echo "âš ï¸  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
            exit 1
        fi
    fi
}

# attachã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ–ãƒ©ãƒ³ãƒåãƒ™ãƒ¼ã‚¹ï¼‰
attach_session() {
    local branch_name="$1"

    # ãƒ–ãƒ©ãƒ³ãƒåãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
    if [[ -z "$branch_name" ]]; then
        branch_name=$(get_current_branch_name)
        if [[ -z "$branch_name" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒ–ãƒ©ãƒ³ãƒåã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„" >&2
            exit 1
        fi
        echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒå: $branch_name"
    fi

    echo "=== vivebox ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ ==="
    echo "ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã‚’æ§‹ç¯‰
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")
    local tmux_session="${git_repo_name//[.\/-]/_}/vibebox"

    # tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! command -v tmux &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo "tmuxã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
        exit 1
    fi

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! tmux has-session -t "$tmux_session" 2>/dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ '$tmux_session' ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚" >&2
        echo
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
        echo "  $0 up $branch_name"
        exit 1
    fi

    # ãƒ–ãƒ©ãƒ³ãƒåã«å¯¾å¿œã™ã‚‹tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã‚’æ§‹ç¯‰
    local tmux_window="${branch_name//[\/.-]/_}"

    # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! tmux list-windows -t "$tmux_session" -F "#{window_name}" | grep -q "^${tmux_window}$"; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
        echo "  $0 up $branch_name"
        exit 1
    fi

    echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: $tmux_session"
    echo "tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: $tmux_window"
    echo "ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™..."
    echo

    # ç‰¹å®šã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¿ãƒƒãƒ
    if [[ -n "$TMUX" ]]; then
        # æ—¢ã«tmuxå†…ã«ã„ã‚‹å ´åˆã¯ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        tmux switch-client -t "$tmux_session:$tmux_window"
    else
        # tmuxå¤–ã‹ã‚‰ã®å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
        tmux attach-session -t "$tmux_session:$tmux_window"
    fi
}

# list-workspaceã‚³ãƒãƒ³ãƒ‰
list_workspaces() {
    echo "=== .vibebox-workspaces ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ ==="
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    local vibebox_dir="$PROJECT_ROOT/.vibebox-workspaces"

    # vibebox-workspacesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$vibebox_dir" ]]; then
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: $vibebox_dir"
        echo
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã«ã¯:"
        echo "  $0 up <branch-name>"
        return 0
    fi

    echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $vibebox_dir"
    echo

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ã‚’å–å¾—
    local workspace_count=0
    local workspaces=()

    for workspace_path in "$vibebox_dir"/*; do
        if [[ -d "$workspace_path" ]]; then
            local branch_name
            branch_name=$(basename "$workspace_path")
            workspaces+=("$branch_name")
            workspace_count=$((workspace_count + 1))
        fi
    done

    if [[ $workspace_count -eq 0 ]]; then
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        echo
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã«ã¯:"
        echo "  $0 up <branch-name>"
        return 0
    fi

    echo "ç·ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ•°: $workspace_count"
    echo
    echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # gitãƒªãƒã‚¸ãƒˆãƒªåã‚’å–å¾—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¸€è¦§è¡¨ç¤º
    for branch_name in "${workspaces[@]}"; do
        local workspace_path="$vibebox_dir/$branch_name"
        echo "ğŸ“ $branch_name"
        echo "   ãƒ‘ã‚¹: $workspace_path"

        # Gitãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å–å¾—
        if git -C "$workspace_path" status >/dev/null 2>&1; then
            local current_branch
            current_branch=$(git -C "$workspace_path" rev-parse --abbrev-ref HEAD 2>/dev/null)
            if [[ -n "$current_branch" ]]; then
                echo "   ãƒ–ãƒ©ãƒ³ãƒ: $current_branch"
            fi

            # æœ€å¾Œã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
            local last_commit
            last_commit=$(git -C "$workspace_path" log -1 --format="%h %s (%cr)" 2>/dev/null)
            if [[ -n "$last_commit" ]]; then
                echo "   æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: $last_commit"
            fi

            # æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! git -C "$workspace_path" diff --quiet 2>/dev/null || ! git -C "$workspace_path" diff --cached --quiet 2>/dev/null; then
                echo "   âš ï¸  æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ã‚ã‚Š"
            fi
        else
            echo "   âš ï¸  Gitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi

        # å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãŒç¨¼åƒä¸­ã‹ãƒã‚§ãƒƒã‚¯
        local sanitized_branch="${branch_name//\//-}"
        local expected_container_name="vibebox.${git_repo_name}.${sanitized_branch}"
        local container_id
        container_id="$(docker_find_running_container_id_by_name "$expected_container_name" || true)"

        if [[ -n "$container_id" ]]; then
            echo "   ğŸŸ¢ ã‚³ãƒ³ãƒ†ãƒŠç¨¼åƒä¸­ ($container_id)"
        else
            echo "   âšª ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ä¸­"
        fi

        # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚µã‚¤ã‚º
        local size
        if command -v du &> /dev/null; then
            size=$(du -sh "$workspace_path" 2>/dev/null | cut -f1)
            if [[ -n "$size" ]]; then
                echo "   ã‚µã‚¤ã‚º: $size"
            fi
        fi

        echo
    done

    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
    echo "ã‚³ãƒãƒ³ãƒ‰:"
    echo "  ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: $0 up <branch-name>"
    echo "  ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ã: $0 edit <branch-name>"
    echo "  ã‚·ã‚§ãƒ«èµ·å‹•: $0 shell <branch-name>"
    echo "  ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢: $0 down <branch-name>"
    echo "  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§: $0 list"
}

# list-sessionã‚³ãƒãƒ³ãƒ‰
list_sessions() {
    echo "=== ç¨¼åƒä¸­ã® vibebox ã‚³ãƒ³ãƒ†ãƒŠã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ ==="
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªåã‚’å–å¾—
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")

    # vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’æ¤œç´¢ï¼ˆãƒªãƒã‚¸ãƒˆãƒªåã‚’å«ã‚€ã‚³ãƒ³ãƒ†ãƒŠï¼‰
    local containers
    containers=$(docker_cmd ps --filter "name=vibebox.${git_repo_name}" --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.CreatedAt}}\t{{.Image}}" 2>/dev/null)

    if [[ -z "$containers" ]] || [[ "$containers" == "CONTAINER ID"* && $(echo "$containers" | wc -l) -eq 1 ]]; then
        echo "ç¾åœ¨ç¨¼åƒä¸­ã®vibeboxã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
        echo
        echo "æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
        echo "  $0 up <branch-name>"
        return 0
    fi

    echo "$containers"
    echo

    # å„ã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
    echo "=== ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´° ==="
    local container_ids
    container_ids=$(docker_cmd ps --filter "name=vibebox.${git_repo_name}" --format "{{.ID}}" 2>/dev/null)

    local count=0
    while IFS= read -r container_id; do
        if [[ -n "$container_id" ]]; then
            count=$((count + 1))
            echo
            echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ #$count"
            echo "----------------------------------------"

            # ã‚³ãƒ³ãƒ†ãƒŠåã‚’å–å¾—
            local container_name
            container_name=$(docker_cmd inspect "$container_id" --format '{{.Name}}' 2>/dev/null | sed 's/^\/*//')
            echo "  ã‚³ãƒ³ãƒ†ãƒŠå: $container_name"
            echo "  ã‚³ãƒ³ãƒ†ãƒŠID: $container_id"

            # ã‚³ãƒ³ãƒ†ãƒŠåã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒåã‚’æŠ½å‡º
            # ãƒ‘ã‚¿ãƒ¼ãƒ³: vibebox.{repo-name}.{branch-name}
            if [[ "$container_name" =~ vibebox\.${git_repo_name}\.(.+)$ ]]; then
                local branch_name="${BASH_REMATCH[1]}"
                # ãƒã‚¤ãƒ•ãƒ³ã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«æˆ»ã™ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºã®é€†ï¼‰
                branch_name="${branch_name//-/\/}"
                echo "  ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"

                # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’è¡¨ç¤º
                local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"
                if [[ -d "$workspace_path" ]]; then
                    echo "  Workspace: $workspace_path"
                fi
            fi

            # ä½œæˆæ™‚é–“ã‚’å–å¾—
            local created_at
            created_at=$(docker_cmd inspect "$container_id" --format '{{.Created}}' 2>/dev/null | sed 's/T/ /' | sed 's/\..*//')
            if [[ -n "$created_at" ]]; then
                echo "  é–‹å§‹æ™‚é–“: $created_at"
            fi

            # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’å–å¾—
            local image_tag
            image_tag=$(docker_cmd inspect "$container_id" --format '{{.Config.Image}}' 2>/dev/null)
            if [[ -n "$image_tag" ]]; then
                echo "  ã‚¤ãƒ¡ãƒ¼ã‚¸: $image_tag"
            fi

            # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ã‚’ç¢ºèª
            local tmux_session="vibebox_${git_repo_name//[.\/-]/_}"

            if [[ "$container_name" =~ vibebox\.${git_repo_name}\.(.+)$ ]]; then
                local sanitized_branch="${BASH_REMATCH[1]}"
                # ãƒã‚¤ãƒ•ãƒ³ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«å¤‰æ›ï¼ˆtmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åç”¨ï¼‰
                local tmux_window="${sanitized_branch//-/_}"

                if command -v tmux &> /dev/null && tmux has-session -t "$tmux_session" 2>/dev/null; then
                    if tmux list-windows -t "$tmux_session" -F "#{window_name}" | grep -q "^${tmux_window}$"; then
                        echo "  tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: ã‚¢ã‚¯ãƒ†ã‚£ãƒ– ($tmux_session:$tmux_window)"
                    else
                        echo "  tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: éã‚¢ã‚¯ãƒ†ã‚£ãƒ–"
                    fi
                else
                    echo "  tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: éã‚¢ã‚¯ãƒ†ã‚£ãƒ–"
                fi
            fi

            # å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª
            local processes
            processes=$(docker_cmd exec "$container_id" ps aux 2>/dev/null | grep -E "(node|python|java)" | grep -v grep | head -3)
            if [[ -n "$processes" ]]; then
                echo "  å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹:"
                echo "$processes" | while IFS= read -r line; do
                    # ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ã‚’ç°¡æ½”ã«è¡¨ç¤º
                    local cmd=$(echo "$line" | awk '{for(i=11;i<=NF;i++) printf "%s ", $i; print ""}' | cut -c1-60)
                    echo "    $cmd"
                done
            fi
        fi
    done <<< "$container_ids"

    if [[ $count -eq 0 ]]; then
        echo "è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
    else
        echo
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã«ã¯:"
        echo "  $0 attach <branch-name>"
        echo
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã™ã‚‹ã«ã¯:"
        echo "  $0 down <branch-name>"
    fi
}

# start-sessionã‚³ãƒãƒ³ãƒ‰
start_session() {
    local branch_name="$1"
    local attach_flag="$2"

    echo "=== vibebox ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ ==="
    echo "ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æ§‹ç¯‰
    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"
    echo "Workspace ãƒ‘ã‚¹: $workspace_path"

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ -d "$workspace_path" ]]; then
        echo "æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™: $workspace_path"

        # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®çŠ¶æ…‹ç¢ºèª
        if ! git -C "$workspace_path" status >/dev/null 2>&1; then
            echo "è­¦å‘Š: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒç„¡åŠ¹ãªçŠ¶æ…‹ã§ã™ã€‚å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã€‚"
            rm -rf "$workspace_path"
        else
            # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ç¢ºèª
            local current_branch
            current_branch=$(git -C "$workspace_path" rev-parse --abbrev-ref HEAD 2>/dev/null)
            echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $current_branch"

            # æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã¨ç•°ãªã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            if [[ "$current_branch" != "$branch_name" ]]; then
                echo "ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­..."
                if ! git -C "$workspace_path" checkout "$branch_name" 2>/dev/null; then
                    echo "è­¦å‘Š: ãƒ–ãƒ©ãƒ³ãƒã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚fetch ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¾ã™ã€‚"
                    git -C "$workspace_path" fetch origin
                    git -C "$workspace_path" checkout "$branch_name" || {
                        echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
                        exit 1
                    }
                fi
            fi

            # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—
            echo "æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ä¸­..."
            if ! git -C "$workspace_path" fetch origin; then
                echo "âš  è­¦å‘Š: git fetchã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™"
            else
                if git -C "$workspace_path" show-ref --verify --quiet "refs/remotes/origin/$branch_name"; then
                    git -C "$workspace_path" merge "origin/$branch_name" --ff-only 2>/dev/null || {
                        echo "è­¦å‘Š: fast-forward mergeãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
                    }
                fi
            fi
        fi
    fi

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    if [[ ! -d "$workspace_path" ]]; then
        echo "Git cloneã‚’å®Ÿè¡Œä¸­..."

        # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p "$(dirname "$workspace_path")"

        # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®URLã‚’å–å¾—
        local remote_url
        remote_url=$(git remote get-url origin 2>/dev/null)
        if [[ -z "$remote_url" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: originãƒªãƒ¢ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
            exit 1
        fi

        echo "ãƒªãƒ¢ãƒ¼ãƒˆURL: $remote_url"
        echo "ã‚¯ãƒ­ãƒ¼ãƒ³å…ˆ: $workspace_path"

        # ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
        if ! git clone "$remote_url" "$workspace_path"; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
            exit 1
        fi

        echo "ã‚¯ãƒ­ãƒ¼ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ: $workspace_path"

        # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        cd "$workspace_path"

        # ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if git show-ref --verify --quiet "refs/heads/$branch_name"; then
            echo "æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¾ã™"
            git checkout "$branch_name" || {
                echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
                exit 1
            }
        elif git show-ref --verify --quiet "refs/remotes/origin/$branch_name"; then
            echo "ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒ 'origin/$branch_name' ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¾ã™"
            git checkout -b "$branch_name" "origin/$branch_name" || {
                echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
                exit 1
            }
        else
            echo "æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã‚’ä½œæˆã—ã¾ã™"
            git checkout -b "$branch_name" || {
                echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
                exit 1
            }
        fi

        echo "ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå®Œäº†"
    fi

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
    if [[ ! -d "$workspace_path" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: $workspace_path" >&2
        exit 1
    fi

    # devcontainer.jsonã‚’èª­ã¿è¾¼ã‚“ã§vibebox.copyFilesã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    cd "$workspace_path"

    echo "æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ä¸­..."
    if ! git pull origin main; then
        echo "âš  è­¦å‘Š: git pull origin mainã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™"
    fi

    local devcontainer_json=".devcontainer/devcontainer.json"
    local devcontainer_local_json=".devcontainer/devcontainer.local.json"

    if [[ ! -f "$devcontainer_json" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: devcontainer.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $devcontainer_json" >&2
        exit 1
    fi

    # jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! command -v jq &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚jqã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚" >&2
        exit 1
    fi

    # ã‚³ãƒ¡ãƒ³ãƒˆã¨æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªJSONã‚’ä½œæˆ
    local cleaned_json=$(sed 's://.*$::g; s:/\*.*\*/::g' "$devcontainer_json")

    # vibebox.copyFilesãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    local copy_files=$(echo "$cleaned_json" | jq -r '.vibebox.copyFiles // empty | .[]?' 2>/dev/null)

    echo "$(pwd)"
    if [[ -n "$copy_files" ]]; then
        echo "vibebox.copyFilesã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
        echo "$copy_files" | while IFS= read -r file_path; do
            if [[ -n "$file_path" && "$file_path" != "null" ]]; then
                local source_file="$PROJECT_ROOT/$file_path"
                local dest_file="$workspace_path/$file_path"
                local dest_dir=$(dirname "$dest_file")

                if [[ -f "$source_file" ]]; then
                    echo "  $file_path ã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
                    # å¿…è¦ã«å¿œã˜ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
                    mkdir -p "$dest_dir"
                    cp "$source_file" "$dest_file"
                    echo "  âœ“ $file_path ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸ"
                else
                    echo "  âš  è­¦å‘Š: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $source_file"
                fi
            fi
        done
    else
        echo "vibebox.copyFilesãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
    fi

    echo

    echo "devcontainer.jsonã‚’èª­ã¿è¾¼ã‚“ã§devcontainer.local.jsonã‚’ä½œæˆä¸­..."

    # gitãƒªãƒã‚¸ãƒˆãƒªåã‚’å–å¾—
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")

    # ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒåï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›ï¼‰
    local sanitized_branch="${branch_name//\//-}"

    # runArgsã‚’æ›´æ–°ï¼ˆ--name=vibebox.{repo_name}.{branch_name}ã®å½¢å¼ã§è¨­å®šï¼‰
    # äº’æ›æ€§ã®ãŸã‚ --env-file æŒ‡å®šã¯è‡ªå‹•ã§é™¤å»ã™ã‚‹
    echo "$cleaned_json" | jq --arg repo_name "$git_repo_name" --arg branch "$sanitized_branch" '
        def strip_env_file_args:
            reduce .[] as $arg (
                {skip_next: false, out: []};
                if .skip_next then
                    .skip_next = false
                elif ($arg | test("^--env-file(=|$)")) then
                    if $arg == "--env-file" then
                        .skip_next = true
                    else
                        .
                    end
                else
                    .out += [$arg]
                end
            ) | .out;

        .runArgs = ((.runArgs // []) | strip_env_file_args)
        |
        if (.runArgs | map(test("^--name=")) | any) then
                # --name=ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç½®æ›
                .runArgs = (.runArgs | map(
                    if test("^--name=") then
                        "--name=vibebox." + $repo_name + "." + $branch
                    else
                        .
                    end
                ))
        else
                # --name=ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
                .runArgs = .runArgs + ["--name=vibebox." + $repo_name + "." + $branch]
        end
    ' > "$devcontainer_local_json"

    echo "devcontainer.local.jsonã‚’ä½œæˆã—ã¾ã—ãŸ"

    # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
    echo "å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­..."

    # devcontainer CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! command -v devcontainer &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: devcontainer CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:" >&2
        echo "  npm install -g @devcontainers/cli" >&2
        exit 1
    fi

    # æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒã‚§ãƒƒã‚¯
    local expected_container_name="vibebox.${git_repo_name}.${sanitized_branch}"

    echo "æ—¢å­˜ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    local existing_container_id

    # ã¾ãšã€ç¨¼åƒä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’ã€Œæƒ³å®šã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠåã€ã§å³å¯†ã«æ¤œç´¢ã™ã‚‹
    # (ãƒ–ãƒ©ãƒ³ãƒåã ã‘ã§æ¤œç´¢ã™ã‚‹ã¨ã€åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã®åŒåãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èª¤ã£ã¦å†åˆ©ç”¨ã—ã¦ã—ã¾ã†)
    existing_container_id="$(docker_find_running_container_id_by_name "$expected_container_name" || true)"
    if [[ -n "$existing_container_id" ]]; then
        echo "æ—¢å­˜ã®ç¨¼åƒä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $expected_container_name ($existing_container_id)"
    fi

            # åå‰ã§ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’æ¢ã™ï¼ˆç¨¼åƒä¸­ã®ã¿ï¼‰
    if [[ -z "$existing_container_id" ]]; then
        local all_running_vibebox_containers
        all_running_vibebox_containers=$(docker_cmd ps --filter "name=vibebox" --format "{{.ID}}" 2>/dev/null)

        if [[ -n "$all_running_vibebox_containers" ]]; then
            while IFS= read -r container_id; do
                if [[ -n "$container_id" ]]; then
                    # ãƒã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ç¢ºèª
                    local mount_info
                    mount_info=$(docker_cmd inspect "$container_id" --format '{{range .Mounts}}{{if eq .Source "'$workspace_path'"}}FOUND{{end}}{{end}}' 2>/dev/null)
                    if [[ "$mount_info" == "FOUND" ]]; then
                        existing_container_id="$container_id"
                        local container_name
                        container_name=$(docker_cmd inspect "$container_id" --format '{{.Name}}' 2>/dev/null | sed 's/^\/*//')
                        echo "æ—¢å­˜ã®ç¨¼åƒä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆãƒã‚¦ãƒ³ãƒˆã§æ¤œç´¢ï¼‰: $container_name ($container_id)"
                        break
                    fi
                fi
            done <<< "$all_running_vibebox_containers"
        fi
    fi

    if [[ -n "$existing_container_id" ]]; then
        # ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’å†ç¢ºèª
        local container_state
        container_state=$(docker_cmd inspect "$existing_container_id" --format '{{.State.Status}}' 2>/dev/null)
        if [[ "$container_state" == "running" ]]; then
            local container_name
            container_name=$(docker_cmd inspect "$existing_container_id" --format '{{.Name}}' 2>/dev/null | sed 's/^\/*//')
            echo "æ—¢å­˜ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¾ã™: $container_name ($existing_container_id)"
        else
            echo "æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠãŒç¨¼åƒã—ã¦ã„ã¾ã›ã‚“ (çŠ¶æ…‹: $container_state)ã€‚æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚"
            existing_container_id=""
        fi
    fi

    if [[ -z "$existing_container_id" ]]; then
        # åœæ­¢ä¸­/ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
        echo "åœæ­¢ä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
        local stopped_containers
        stopped_containers=$(docker_cmd ps -a --filter "name=vibebox" --filter "status=exited" --format "{{.ID}}" 2>/dev/null)
        if [[ -n "$stopped_containers" ]]; then
            echo "$stopped_containers" | xargs envchain "$IMAGE_NAME" docker rm -f >/dev/null 2>&1 || true
            echo "âœ“ åœæ­¢ä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        fi

        # devcontainerã‚’èµ·å‹•
        echo "vibeboxã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ä¸­..."
        echo "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: $(devcontainer_cmd_prefix) up --override-config $devcontainer_local_json --workspace-folder ."
        echo "å‡¦ç†ä¸­... (æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)"
        echo

        # devcontainer upã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        # å‡ºåŠ›ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã—ã¤ã¤ã€æœ€å¾Œã®è¡Œï¼ˆJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ã‚’ä¿å­˜
        local temp_file=$(mktemp)

        # devcontainer upã‚’å®Ÿè¡Œã—ã€å‡ºåŠ›ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ä¸¡æ–¹ã«é€ã‚‹
        if devcontainer_cmd up --override-config "$devcontainer_local_json" --workspace-folder . | tee "$temp_file"; then
            echo
            echo "devcontainerãŒèµ·å‹•ã—ã¾ã—ãŸ"

            # æœ€å¾Œã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹è¡Œã‚’å–å¾—
            local devcontainer_result
            devcontainer_result=$(tail -1 "$temp_file")

            # JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰containerIdã‚’å–å¾—
            existing_container_id=$(echo "$devcontainer_result" | jq -r '.containerId // empty' 2>/dev/null)

            if [[ -z "$existing_container_id" ]]; then
                echo "è­¦å‘Š: JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰containerIdã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
                echo "æœ€å¾Œã®è¡Œ: $devcontainer_result" >&2

                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€æ–°ã®devcontainerã‚’æ¢ã™
                echo "ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€æ–°ã®devcontainerã‚’æ¤œç´¢ä¸­..."
                existing_container_id=$(docker_cmd ps --filter "name=devcontainer" --format "{{.ID}}\t{{.CreatedAt}}" | sort -k2 -r | head -1 | cut -f1)

                if [[ -n "$existing_container_id" ]]; then
                    echo "æœ€æ–°ã®devcontainerã‚’ä½¿ç”¨ã—ã¾ã™: $existing_container_id"
                else
                    echo "ã‚¨ãƒ©ãƒ¼: devcontainerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >&2
                    rm -f "$temp_file"
                    exit 1
                fi
            fi
        else
            echo "ã‚¨ãƒ©ãƒ¼: devcontainerã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
            rm -f "$temp_file"
            exit 1
        fi

        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -f "$temp_file"
    fi

    echo "ã‚³ãƒ³ãƒ†ãƒŠID: $existing_container_id"
    echo

    docker_cmd exec "$existing_container_id" sudo bash -c "echo $branch_name > /var/run/vibebox-current-workspace"

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã‚’è¨­å®š
    local tmux_session="${git_repo_name//[.\/-]/_}/vibebox"
    local tmux_window="${branch_name//[\/.-]/_}"

    echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³: $tmux_session"
    echo "tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: $tmux_window"
    echo

    # tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! command -v tmux &> /dev/null; then
        echo "è­¦å‘Š: tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™ã€‚"
        echo "ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ã¾ã™..."
        echo "çµ‚äº†ã™ã‚‹ã«ã¯ 'exit' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        echo

        # Cursorã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ã
        if command -v cursor &> /dev/null; then
            echo "Cursorã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ã„ã¦ã„ã¾ã™..."
            cursor "$workspace_path" &
        fi

        # devcontainerã§ã‚·ã‚§ãƒ«ã‚’èµ·å‹•
        docker_cmd exec -it "$existing_container_id" sh -c 'cd /workspace && exec $SHELL'
        return
    fi

    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! tmux has-session -t "$tmux_session" 2>/dev/null; then
        echo "æ–°ã—ã„tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™: $tmux_session"
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã€æœ€åˆã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’consoleï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚·ã‚§ãƒ«ï¼‰ã¨ã—ã¦èµ·å‹•
        tmux new-session -d -s "$tmux_session" -n "console" -c "$PROJECT_ROOT"
        # ãƒ–ãƒ©ãƒ³ãƒç”¨ã®æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ
        echo "ãƒ–ãƒ©ãƒ³ãƒç”¨ã®tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆã—ã¾ã™: $tmux_window"
        tmux new-window -t "$tmux_session" -n "$tmux_window" -c "$workspace_path"
    else
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å­˜åœ¨ã™ã‚‹ãŒã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if tmux list-windows -t "$tmux_session" -F "#{window_name}" | grep -q "^${tmux_window}$"; then
            echo "æ—¢å­˜ã®tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $tmux_session:$tmux_window"

            # --attachãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¢ã‚¿ãƒƒãƒ
            if [[ "$attach_flag" == "true" ]]; then
                echo "æ—¢å­˜ã®tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™..."
                # æ—¢ã«tmuxå†…ã«ã„ã‚‹å ´åˆ
                if [[ -n "$TMUX" ]]; then
                    tmux switch-client -t "$tmux_session:$tmux_window"
                else
                    tmux attach-session -t "$tmux_session:$tmux_window"
                fi
            else
                echo "æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
                echo "  $0 attach $branch_name"
            fi
            return
        else
            echo "æ–°ã—ã„tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆã—ã¾ã™: $tmux_window"
            tmux new-window -t "$tmux_session" -n "$tmux_window" -c "$workspace_path"
        fi
    fi

    # workspaceFolderã‚’å–å¾—
    local workspace_folder
    workspace_folder=$(get_devcontainer_workspace_folder)

    # workspaceFolderãŒå­˜åœ¨ã™ã‚‹ã‹devcontainerå†…ã§ç¢ºèª
    local actual_workspace_folder
    if [[ "$workspace_folder" == '\$HOME' ]] || docker_cmd exec "$existing_container_id" test -d "$workspace_folder" 2>/dev/null; then
        actual_workspace_folder="$workspace_folder"
    else
        echo "è­¦å‘Š: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ•ã‚©ãƒ«ãƒ€ '$workspace_folder' ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
        actual_workspace_folder='\$HOME'
    fi

    echo "actual_workspace_folder: $actual_workspace_folder"

    # devcontainerã§ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã™ã‚‹Dockerã‚³ãƒãƒ³ãƒ‰ã‚’æ§‹ç¯‰
    local docker_exec_cmd
    if [[ "$actual_workspace_folder" == '\$HOME' ]]; then
        docker_exec_cmd="$(docker_cmd_prefix) exec -e TERM=xterm-256color -e COLORTERM=truecolor -it \"$existing_container_id\" bash -c 'cd \$HOME && exec \$SHELL'"
    else
        docker_exec_cmd="$(docker_cmd_prefix) exec -e TERM=xterm-256color -e COLORTERM=truecolor -it \"$existing_container_id\" bash -c \"cd $actual_workspace_folder && exec \\\$SHELL\""
    fi

    # tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§Dockerã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
    tmux send-keys -t "$tmux_session:$tmux_window" "$docker_exec_cmd" Enter

    # Cursorã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ã
    if command -v cursor &> /dev/null; then
        echo "Cursorã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ã„ã¦ã„ã¾ã™..."
        cursor "$workspace_path" &
    fi

    # --attachãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
    if [[ "$attach_flag" == "true" ]]; then
        echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒã—ã¦ã„ã¾ã™..."
        if [[ -n "$TMUX" ]]; then
            # æ—¢ã«tmuxå†…ã«ã„ã‚‹å ´åˆã¯ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            tmux switch-client -t "$tmux_session:$tmux_window"
        else
            # tmuxå¤–ã‹ã‚‰ã®å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
            tmux attach-session -t "$tmux_session:$tmux_window"
        fi
    else
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo "  $0 attach $branch_name"
    fi
}

# shellã‚³ãƒãƒ³ãƒ‰
shell_session() {
    local branch_name="$1"

    # ãƒ–ãƒ©ãƒ³ãƒåãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
    if [[ -z "$branch_name" ]]; then
        branch_name=$(get_current_branch_name)
        if [[ -z "$branch_name" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒ–ãƒ©ãƒ³ãƒåã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„" >&2
            exit 1
        fi
        echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒå: $branch_name"
    fi

    echo "=== vibebox ã®ã‚·ã‚§ãƒ«ã‚’èµ·å‹• ==="
    echo "ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    # gitãƒªãƒã‚¸ãƒˆãƒªåã‚’å–å¾—
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")

    # ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒåï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›ï¼‰
    local sanitized_branch="${branch_name//\//-}"
    local expected_container_name="vibebox.${git_repo_name}.${sanitized_branch}"

    # ã‚³ãƒ³ãƒ†ãƒŠIDã‚’æ¤œç´¢
    local container_id=""
    container_id="$(docker_find_running_container_id_by_name "$expected_container_name" || true)"

    # ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
    if [[ -z "$container_id" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
        echo "  $0 up $branch_name"
        exit 1
    fi

    echo "ã‚³ãƒ³ãƒ†ãƒŠå: $expected_container_name"
    echo "ã‚³ãƒ³ãƒ†ãƒŠID: $container_id"
    echo "ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ã¾ã™..."
    echo "çµ‚äº†ã™ã‚‹ã«ã¯ 'exit' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
    echo

    # workspaceFolderã‚’å–å¾—
    local workspace_folder
    workspace_folder=$(get_devcontainer_workspace_folder)

    # workspaceFolderãŒå­˜åœ¨ã™ã‚‹ã‹vibeboxã‚³ãƒ³ãƒ†ãƒŠå†…ã§ç¢ºèª
    local actual_workspace_folder
    if [[ "$workspace_folder" == '\$HOME' ]] || docker_cmd exec "$container_id" test -d "$workspace_folder" 2>/dev/null; then
        actual_workspace_folder="$workspace_folder"
    else
        echo "è­¦å‘Š: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ•ã‚©ãƒ«ãƒ€ '$workspace_folder' ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
        actual_workspace_folder='\$HOME'
    fi

    # ã‚·ã‚§ãƒ«ã‚’èµ·å‹•
    if [[ "$actual_workspace_folder" == '\$HOME' ]]; then
        docker_cmd exec -e TERM=xterm-256color -e COLORTERM=truecolor -it "$container_id" bash -c 'cd $HOME && exec $SHELL'
    else
        docker_cmd exec -e TERM=xterm-256color -e COLORTERM=truecolor -it "$container_id" bash -c "cd $actual_workspace_folder && exec \$SHELL"
    fi
}

# editã‚³ãƒãƒ³ãƒ‰
edit_session() {
    local branch_name="$1"

    # ãƒ–ãƒ©ãƒ³ãƒåãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
    if [[ -z "$branch_name" ]]; then
        branch_name=$(get_current_branch_name)
        if [[ -z "$branch_name" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒ–ãƒ©ãƒ³ãƒåã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„" >&2
            exit 1
        fi
        echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒå: $branch_name"
    fi

    echo "=== ãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’Cursorã§é–‹ã ==="
    echo "ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æ§‹ç¯‰
    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"

    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$workspace_path" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“: $workspace_path" >&2
        echo
        echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã«ã¯:"
        echo "  $0 up $branch_name"
        exit 1
    fi

    echo "Workspace ãƒ‘ã‚¹: $workspace_path"

    # CursorãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! command -v cursor &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: CursorãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo "Cursorã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
        exit 1
    fi

    echo "Cursorã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ãã¾ã™..."
    echo

    # Cursorã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ã
    cursor "$workspace_path"

    echo "Cursorã§ '$branch_name' ãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ãã¾ã—ãŸã€‚"
}

cd_local_session() {
    local branch_name="$1"

    if [[ -z "$branch_name" ]]; then
        branch_name=$(get_current_branch_name)
        if [[ -z "$branch_name" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒ–ãƒ©ãƒ³ãƒåã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„" >&2
            exit 1
        fi
        echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒå: $branch_name"
    fi

    echo "=== ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’tmuxã§é–‹ã ==="
    echo "ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"
    echo

    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"
    if [[ ! -d "$workspace_path" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“: $workspace_path" >&2
        echo "  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã«ã¯: $0 up $branch_name" >&2
        exit 1
    fi
    echo "Workspace ãƒ‘ã‚¹: $workspace_path"
    echo

    if ! command -v tmux &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" >&2
        echo "tmuxã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
        exit 1
    fi

    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")
    local tmux_session="${git_repo_name//[.\/-]/_}/vibebox"
    local tmux_window="${branch_name//[\/.-]/_}(local)"

    if ! tmux has-session -t "$tmux_session" 2>/dev/null; then
        echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™: $tmux_session"
        tmux new-session -d -s "$tmux_session" -n "console" -c "$PROJECT_ROOT"
    fi

    if tmux list-windows -t "$tmux_session" -F "#{window_name}" | grep -Fxq "$tmux_window"; then
        echo "æ—¢å­˜ã®tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½¿ç”¨ã—ã¾ã™: $tmux_session:$tmux_window"
        tmux send-keys -t "$tmux_session:$tmux_window" "cd $workspace_path" Enter
    else
        echo "tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆã—ã¾ã™: $tmux_session:$tmux_window"
        tmux new-window -t "$tmux_session" -n "$tmux_window" -c "$workspace_path"
    fi

    echo
    echo "tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç§»å‹•ã—ã¾ã™..."
    if [[ -n "$TMUX" ]]; then
        tmux switch-client -t "$tmux_session:$tmux_window"
    else
        tmux attach-session -t "$tmux_session:$tmux_window"
    fi
}

# secrets setã‚³ãƒãƒ³ãƒ‰
secrets_set() {
    echo "=== vibebox AWSã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š ==="
    echo

    if ! command -v envchain &> /dev/null; then
        echo "ã‚¨ãƒ©ãƒ¼: envchain ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚brew install envchain ãªã©ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚" >&2
        exit 1
    fi

    local envchain_service="$IMAGE_NAME"

    echo "envchainã‚µãƒ¼ãƒ“ã‚¹å: $envchain_service"
    echo "è¨­å®šå¯¾è±¡: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION, AWS_REGION"
    echo "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ç©ºæ¬„ã®ã¾ã¾Enterã§ã‚¹ã‚­ãƒƒãƒ—)"
    echo

    if envchain --set "$envchain_service" \
        AWS_ACCESS_KEY_ID \
        AWS_SECRET_ACCESS_KEY \
        AWS_DEFAULT_REGION \
        AWS_REGION; then
        echo
        echo "âœ“ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ"
    else
        echo
        echo "âœ— ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
        exit 1
    fi
}

# initã‚³ãƒãƒ³ãƒ‰
init_vibebox() {
    echo "=== vibebox ã‚’åˆæœŸåŒ– ==="
    echo

    # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
    local target_dir="$(pwd)"
    local target_vibebox_dir="$target_dir/.vibebox"

    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’ç‰¹å®š
    local script_path
    script_path="$(resolve_absolute_path "${BASH_SOURCE[0]}")"
    local script_dir="$(dirname "$script_path")"
    local template_dir="$script_dir/.vibebox"

    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
    if [[ ! -d "$template_dir" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $template_dir" >&2
        exit 1
    fi

    # å¿…è¦ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if [[ ! -f "$template_dir/claude-pty" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: claude-ptyãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $template_dir/claude-pty" >&2
        exit 1
    fi

    if [[ ! -f "$template_dir/Dockerfile.template" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: Dockerfile.templateãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $template_dir/Dockerfile.template" >&2
        exit 1
    fi

    # .vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ -d "$target_vibebox_dir" ]]; then
        echo "è­¦å‘Š: .vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: $target_vibebox_dir"
        read -p "æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "åˆæœŸåŒ–ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
            exit 0
        fi
    fi

    # .vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ: $target_vibebox_dir"
    mkdir -p "$target_vibebox_dir"

    # claude-ptyã‚’ã‚³ãƒ”ãƒ¼
    echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼: claude-pty"
    cp "$template_dir/claude-pty" "$target_vibebox_dir/claude-pty"
    chmod +x "$target_vibebox_dir/claude-pty"

    # BASE_IMAGEã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
    echo
    echo "ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
    echo "ä¾‹:"
    echo "  - ubuntu:22.04"
    echo "  - python:3.11-slim"
    echo "  - node:20-alpine"
    echo
    read -p "BASE_IMAGE [ubuntu:22.04]: " base_image

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
    if [[ -z "$base_image" ]]; then
        base_image="ubuntu:22.04"
    fi

    echo
    echo "ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸: $base_image"

    # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’å–å¾—
    local repo_name="$(basename "$target_dir")"

    local container_username
    read -p "ã‚³ãƒ³ãƒ†ãƒŠå†…ãƒ¦ãƒ¼ã‚¶ãƒ¼å [${DEFAULT_CONTAINER_USERNAME}]: " container_username
    if [[ -z "$container_username" ]]; then
        container_username="$DEFAULT_CONTAINER_USERNAME"
    fi

    local default_devcontainer_image="${VIBEBOX_DEVCONTAINER_IMAGE:-vibebox/${repo_name}:latest}"
    local devcontainer_image
    read -p "devcontainer image [$default_devcontainer_image]: " devcontainer_image
    if [[ -z "$devcontainer_image" ]]; then
        devcontainer_image="$default_devcontainer_image"
    fi

    local default_envchain_service="${VIBEBOX_ENVCHAIN_SERVICE:-vibebox:${repo_name}:ecr}"
    local envchain_service
    read -p "envchain service [$default_envchain_service]: " envchain_service
    if [[ -z "$envchain_service" ]]; then
        envchain_service="$default_envchain_service"
    fi

    # Dockerfile.templateã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ç½®æ›
    echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ: Dockerfile"
    local escaped_base_image
    local escaped_container_username
    escaped_base_image=$(escape_sed_replacement "$base_image")
    escaped_container_username=$(escape_sed_replacement "$container_username")
    sed \
        -e "s|{BASE_IMAGE}|$escaped_base_image|g" \
        -e "s|{USERNAME}|$escaped_container_username|g" \
        "$template_dir/Dockerfile.template" > "$target_vibebox_dir/Dockerfile"

    # .devcontainerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    mkdir -p "$target_dir/.devcontainer"

    # .devcontainerãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
    if [[ -f "$template_dir/.devcontainer/devcontainer.json" ]]; then
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ: .devcontainer/devcontainer.json"
        local escaped_repo_name
        local escaped_devcontainer_image
        local escaped_envchain_service
        escaped_repo_name=$(escape_sed_replacement "$repo_name")
        escaped_devcontainer_image=$(escape_sed_replacement "$devcontainer_image")
        escaped_envchain_service=$(escape_sed_replacement "$envchain_service")
        sed \
            -e "s|{REPO_NAME}|$escaped_repo_name|g" \
            -e "s|{USERNAME}|$escaped_container_username|g" \
            -e "s|{DEVCONTAINER_IMAGE}|$escaped_devcontainer_image|g" \
            -e "s|{ENVCHAIN_SERVICE}|$escaped_envchain_service|g" \
            "$template_dir/.devcontainer/devcontainer.json" > "$target_dir/.devcontainer/devcontainer.json"
    fi

    if [[ -f "$template_dir/.devcontainer/hooks-post-start.sh" ]]; then
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼: .devcontainer/hooks-post-start.sh"
        cp "$template_dir/.devcontainer/hooks-post-start.sh" "$target_dir/.devcontainer/hooks-post-start.sh"
        chmod +x "$target_dir/.devcontainer/hooks-post-start.sh"
    fi

    if [[ -f "$template_dir/.devcontainer/ecr-login.sh" ]]; then
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼: .devcontainer/ecr-login.sh"
        cp "$template_dir/.devcontainer/ecr-login.sh" "$target_dir/.devcontainer/ecr-login.sh"
        chmod +x "$target_dir/.devcontainer/ecr-login.sh"
    fi

    echo
    echo "=== åˆæœŸåŒ–å®Œäº† ==="
    echo ".vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã—ãŸ: $target_vibebox_dir"
    echo
    echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo "1. å¿…è¦ã«å¿œã˜ã¦ $target_vibebox_dir/Dockerfile ã‚’ç·¨é›†ã—ã¦ãã ã•ã„"
    echo "2. 'vibebox container build' ã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„"
    echo "3. 'vibebox up <branch-name>' ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„"
}

# cleanupã‚³ãƒãƒ³ãƒ‰
cleanup_worktrees() {
    echo "=== vibeboxãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ ==="
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    local vibebox_dir="$PROJECT_ROOT/.vibebox-workspaces"

    # vibebox-workspacesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$vibebox_dir" ]]; then
        echo "å‰Šé™¤å¯¾è±¡ã®vibeboxãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $vibebox_dir"
        return 0
    fi

    echo "vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $vibebox_dir"
    echo

    local vibebox_container_name="vibebox.${git_repo_name}"

    # ç¨¼åƒä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    local running_sessions
    running_sessions=$(docker_cmd ps --filter "name=${vibebox_container_name}" --format "{{.ID}}" 2>/dev/null)

    if [[ -n "$running_sessions" ]]; then
        echo "âš ï¸  è­¦å‘Š: ä»¥ä¸‹ã®vibeboxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¨¼åƒä¸­ã§ã™ï¼š"
        echo

        # å„ã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°ã‚’è¡¨ç¤º
        while IFS= read -r container_id; do
            if [[ -n "$container_id" ]]; then
                # ãƒã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ–ãƒ©ãƒ³ãƒåã‚’æŠ½å‡º
                local mount_info branch_name
                local all_mounts
                all_mounts=$(docker_cmd inspect "$container_id" --format '{{range .Mounts}}{{printf "%s:%s\n" .Source .Destination}}{{end}}' 2>/dev/null)
                mount_info=$(echo "$all_mounts" | grep -E ":(/workspace|/home/[^/]+/workspace)/" | head -1)

                if [[ -n "$mount_info" ]]; then
                    local source_path="${mount_info%%:*}"
                    local dest_path="${mount_info##*:}"

                    if [[ "$dest_path" =~ ^/workspace/(.+)$ ]]; then
                        branch_name="${BASH_REMATCH[1]}"
                        echo "  - ãƒ–ãƒ©ãƒ³ãƒ: $branch_name (ã‚³ãƒ³ãƒ†ãƒŠID: $container_id)"
                    elif [[ "$dest_path" =~ ^/home/[^/]+/workspace/(.+)$ ]]; then
                        branch_name="${BASH_REMATCH[1]}"
                        echo "  - ãƒ–ãƒ©ãƒ³ãƒ: $branch_name (ã‚³ãƒ³ãƒ†ãƒŠID: $container_id)"
                    fi
                fi
            fi
        done <<< "$running_sessions"

        echo
        echo "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š"
        echo "  $0 down --all"
        echo
        read -p "ç¨¼åƒä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
            exit 1
        fi
        echo
    fi

    # æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¸€è¦§è¡¨ç¤º
    echo "å‰Šé™¤å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼š"
    local workspace_count=0
    if [[ -d "$vibebox_dir" ]]; then
        for workspace_path in "$vibebox_dir"/*; do
            if [[ -d "$workspace_path" ]]; then
                local branch_name
                branch_name=$(basename "$workspace_path")
                echo "  - $branch_name ($workspace_path)"
                workspace_count=$((workspace_count + 1))
            fi
        done
    fi

    if [[ $workspace_count -eq 0 ]]; then
        echo "  å‰Šé™¤å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        return 0
    fi

    echo
    echo "åˆè¨ˆ $workspace_count å€‹ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
    echo

    # ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    read -p "æœ¬å½“ã«ã™ã¹ã¦ã®vibeboxãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
        exit 0
    fi

    echo
    echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."

    # cloneã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    local removed_count=0
    local error_count=0

    for workspace_path in "$vibebox_dir"/*; do
        if [[ -d "$workspace_path" ]]; then
            local branch_name
            branch_name=$(basename "$workspace_path")

            echo "  å‰Šé™¤ä¸­: $branch_name"

            # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›´æ¥å‰Šé™¤
            if rm -rf "$workspace_path" 2>/dev/null; then
                echo "    âœ“ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
                removed_count=$((removed_count + 1))
            else
                echo "    âœ— ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
                error_count=$((error_count + 1))
            fi
        fi
    done

    # vibebox-workspacesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè‡ªä½“ãŒç©ºã«ãªã£ãŸå ´åˆã¯å‰Šé™¤
    if [[ -d "$vibebox_dir" ]] && [[ -z "$(ls -A "$vibebox_dir" 2>/dev/null)" ]]; then
        echo "  ç©ºã®vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤: $vibebox_dir"
        rmdir "$vibebox_dir" 2>/dev/null || true
    fi

    echo
    echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº† ==="
    echo "å‰Šé™¤ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: $removed_count å€‹"
    if [[ $error_count -gt 0 ]]; then
        echo "å‰Šé™¤ã«å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: $error_count å€‹"
    fi

    echo
    echo "ã™ã¹ã¦ã®vibeboxãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
}

# rmã‚³ãƒãƒ³ãƒ‰ - å˜ä¸€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å‰Šé™¤
remove_workspace() {
    echo "=== vibeboxãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ ==="
    local branch_name="$1"

    # ãƒ–ãƒ©ãƒ³ãƒåãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
    if [[ -z "$branch_name" ]]; then
        branch_name=$(get_current_branch_name)
        if [[ -z "$branch_name" ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            echo "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ãƒ–ãƒ©ãƒ³ãƒåã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ãã ã•ã„" >&2
            exit 1
        fi
        echo "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒå: $branch_name"
    fi

    # gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$PROJECT_ROOT/.git" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒgitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“" >&2
        exit 1
    fi

    local workspace_path="$PROJECT_ROOT/.vibebox-workspaces/$branch_name"
    if [[ ! -d "$workspace_path" ]]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $workspace_path" >&2
        exit 1
    fi

    echo "å¯¾è±¡ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: $workspace_path"

    # å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãŒç¨¼åƒä¸­ã‹ãƒã‚§ãƒƒã‚¯
    local git_repo_name
    git_repo_name=$(basename "$PROJECT_ROOT")
    local sanitized_branch="${branch_name//\//-}"
    local expected_container_name="vibebox.${git_repo_name}.${sanitized_branch}"
    local container_id
    container_id="$(docker_find_running_container_id_by_name "$expected_container_name" || true)"

    if [[ -n "$container_id" ]]; then
        echo "âš ï¸  ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠãŒç¨¼åƒä¸­ã§ã™: $expected_container_name ($container_id)"
        echo "  å…ˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã™ã‚‹ã«ã¯: $0 down $branch_name"
    fi

    # ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    read -p "æœ¬å½“ã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ '$branch_name' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å‰Šé™¤ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
        exit 0
    fi

    # ç¨¼åƒä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹å ´åˆã®è¿½åŠ ç¢ºèª
    if [[ -n "$container_id" ]]; then
        read -p "ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã›ãšã«å‰Šé™¤ã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "å‰Šé™¤ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
            exit 1
        fi
    fi

    if remove_workspace_directory "$branch_name"; then
        return 0
    else
        exit 1
    fi
}

# doctor ã‚³ãƒãƒ³ãƒ‰ - ç’°å¢ƒãƒã‚§ãƒƒã‚¯
doctor_check() {
    echo "=== vibebox ç’°å¢ƒè¨ºæ–­ ==="
    echo

    local overall_status="OK"
    local warning_count=0
    local error_count=0

    # ãƒã‚§ãƒƒã‚¯çµæœã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®é–¢æ•°
    log_check() {
        local status="$1"
        local message="$2"
        local details="$3"

        case "$status" in
            "OK")
                echo "âœ“ $message"
                ;;
            "WARNING")
                echo "âš ï¸  $message"
                warning_count=$((warning_count + 1))
                if [[ "$overall_status" == "OK" ]]; then
                    overall_status="WARNING"
                fi
                ;;
            "ERROR")
                echo "âœ— $message"
                error_count=$((error_count + 1))
                overall_status="ERROR"
                ;;
        esac

        if [[ -n "$details" ]]; then
            echo "   $details"
        fi
    }

    echo "â–  åŸºæœ¬ç’°å¢ƒãƒã‚§ãƒƒã‚¯"
    echo

    # gitãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯
    if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        log_check "OK" "Gitãƒªãƒã‚¸ãƒˆãƒª"

        # ãƒªãƒ¢ãƒ¼ãƒˆoriginã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if git remote get-url origin >/dev/null 2>&1; then
            local remote_url
            remote_url=$(git remote get-url origin)
            log_check "OK" "Gitãƒªãƒ¢ãƒ¼ãƒˆ (origin): $remote_url"
        else
            log_check "ERROR" "Gitãƒªãƒ¢ãƒ¼ãƒˆ (origin) ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "   git remote add origin <repository-url> ã§è¨­å®šã—ã¦ãã ã•ã„"
        fi
    else
        log_check "ERROR" "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒGitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“"
        echo "   git init ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆæœŸåŒ–ã™ã‚‹ã‹ã€Gitãƒªãƒã‚¸ãƒˆãƒªå†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„"
    fi

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®ç¢ºèª
    if [[ -n "$PROJECT_ROOT" ]]; then
        log_check "OK" "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: $PROJECT_ROOT"
    else
        log_check "ERROR" "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ç‰¹å®šã§ãã¾ã›ã‚“"
    fi

    echo
    echo "â–  vibebox è¨­å®šãƒã‚§ãƒƒã‚¯"
    echo

    # .vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    if [[ -d "$PROJECT_ROOT/.vibebox" ]]; then
        log_check "OK" ".vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"

        # Dockerfile
        if [[ -f "$PROJECT_ROOT/.vibebox/Dockerfile" ]]; then
            log_check "OK" "Dockerfile"
        else
            log_check "ERROR" "DockerfileãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "   'vibebox init' ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã‹ã€æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„"
        fi
    else
        log_check "ERROR" ".vibeboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        echo "   'vibebox init' ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„"
    fi

    # .devcontainerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    if [[ -d "$PROJECT_ROOT/.devcontainer" ]]; then
        log_check "OK" ".devcontainerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"

        # devcontainer.json
        if [[ -f "$PROJECT_ROOT/.devcontainer/devcontainer.json" ]]; then
            log_check "OK" "devcontainer.json"

                                    # JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆJSONCå¯¾å¿œï¼‰
            if command -v jq &> /dev/null; then
                # ã‚³ãƒ¡ãƒ³ãƒˆã€æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªJSONã‚’ä½œæˆ
                local cleaned_json
                cleaned_json=$(sed 's://.*$::g; s:/\*.*\*/::g' "$PROJECT_ROOT/.devcontainer/devcontainer.json" | \
                              sed 's/,\s*\]/]/g; s/,\s*}/}/g' 2>/dev/null)

                if [[ -n "$cleaned_json" ]] && echo "$cleaned_json" | jq . >/dev/null 2>&1; then
                    log_check "OK" "devcontainer.json æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆJSONCå¯¾å¿œï¼‰"

                    # devcontainer.jsonã®å†…å®¹ã‚’è©³ç´°ãƒã‚§ãƒƒã‚¯
                    echo
                    echo "  â— devcontainer.json è©³ç´°è¨­å®šãƒã‚§ãƒƒã‚¯"

                    # Claudeé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                    local claude_mount_count=0
                    if echo "$cleaned_json" | jq -r '.mounts[]?' 2>/dev/null | grep -q "\.claude,target="; then
                        log_check "OK" "  Claudeè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒã‚¦ãƒ³ãƒˆ (.claude)"
                        claude_mount_count=$((claude_mount_count + 1))
                    else
                        log_check "WARNING" "  Claudeè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (.claude)"
                    fi

                    if echo "$cleaned_json" | jq -r '.mounts[]?' 2>/dev/null | grep -q "\.claude\.json,target="; then
                        log_check "OK" "  Claudeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¦ãƒ³ãƒˆ (.claude.json)"
                        claude_mount_count=$((claude_mount_count + 1))
                    else
                        log_check "WARNING" "  Claudeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (.claude.json)"
                    fi

                    # GitHubèªè¨¼æƒ…å ±ã®ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                    if echo "$cleaned_json" | jq -r '.mounts[]?' 2>/dev/null | grep -q "devcontainer-gh-config"; then
                        log_check "OK" "  GitHubèªè¨¼æƒ…å ±ãƒã‚¦ãƒ³ãƒˆ (gh config)"
                    else
                        log_check "WARNING" "  GitHubèªè¨¼æƒ…å ±ãƒã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                        echo "     source=devcontainer-gh-config-\${localEnv:USER} ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                    fi

                    # zsh_historyã®ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                    if echo "$cleaned_json" | jq -r '.mounts[]?' 2>/dev/null | grep -q "\.zsh_history"; then
                        log_check "OK" "  zshå±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¦ãƒ³ãƒˆ (.zsh_history)"
                    else
                        log_check "WARNING" "  zshå±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                        echo "     .devcontainer/.zsh_history ã®ãƒã‚¦ãƒ³ãƒˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                    fi

                    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒã‚§ãƒƒã‚¯
                    local workspace_folder
                    workspace_folder=$(echo "$cleaned_json" | jq -r '.workspaceFolder // empty' 2>/dev/null)
                    if [[ "$workspace_folder" == "/workspace" ]]; then
                        log_check "OK" "  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $workspace_folder"
                    else
                        log_check "WARNING" "  ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒ /workspace ã§ã¯ã‚ã‚Šã¾ã›ã‚“: $workspace_folder"
                        echo "     workspaceFolder ã‚’ /workspace ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
                    fi

                    # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
                    local image_name
                    image_name=$(echo "$cleaned_json" | jq -r '.image // empty' 2>/dev/null)
                    if [[ "$image_name" =~ vibebox ]]; then
                        log_check "OK" "  Dockerã‚¤ãƒ¡ãƒ¼ã‚¸: vibeboxç”±æ¥ ($image_name)"
                    else
                        log_check "WARNING" "  Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãŒvibeboxç”±æ¥ã§ã¯ã‚ã‚Šã¾ã›ã‚“: $image_name"
                        echo "     æŒ¯ã‚Šè¿”ã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ã«vibeboxãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
                    fi

                    # initializeCommandãƒã‚§ãƒƒã‚¯
                    local initialize_command
                    initialize_command=$(echo "$cleaned_json" | jq -r '.initializeCommand[]? // empty' 2>/dev/null | tr '\n' ' ')
                    if [[ -n "$initialize_command" ]]; then
                        log_check "OK" "  initializeCommandè¨­å®šã‚ã‚Š"

                        # GitHub userã®å‡ºåŠ›ãƒã‚§ãƒƒã‚¯
                        if echo "$initialize_command" | grep -q "gh api user.*\.github-user"; then
                            log_check "OK" "    GitHub useræƒ…å ±ã®å–å¾—è¨­å®š"
                        else
                            log_check "WARNING" "    GitHub useræƒ…å ±ã®å–å¾—è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                            echo "       'gh api user -q .login > .devcontainer/.github-user' ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                        fi

                        # .zsh_historyãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒã‚§ãƒƒã‚¯
                        if echo "$initialize_command" | grep -q "touch.*\.zsh_history"; then
                            log_check "OK" "    zshå±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆè¨­å®š"
                        else
                            log_check "WARNING" "    zshå±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                            echo "       'touch .devcontainer/.zsh_history' ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                        fi
                    else
                        log_check "WARNING" "  initializeCommandãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                        echo "     GitHubèªè¨¼ã¨zshå±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–è¨­å®šã‚’æ¨å¥¨ã—ã¾ã™"
                    fi

                    # postStartCommandãƒã‚§ãƒƒã‚¯
                    local post_start_command
                    post_start_command=$(echo "$cleaned_json" | jq -r '.postStartCommand // empty' 2>/dev/null)
                    if [[ -n "$post_start_command" ]]; then
                        log_check "OK" "  postStartCommandè¨­å®šã‚ã‚Š"

                        # hooks-post-start.shã®å®Ÿè¡Œãƒã‚§ãƒƒã‚¯
                        if echo "$post_start_command" | grep -q "hooks-post-start\.sh"; then
                            log_check "OK" "    hooks-post-start.shå®Ÿè¡Œè¨­å®š"
                        else
                            log_check "WARNING" "    hooks-post-start.shå®Ÿè¡Œè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                            echo "       hooks-post-start.shã®å®Ÿè¡Œè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                        fi
                    else
                        log_check "WARNING" "  postStartCommandãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                        echo "     hooks-post-start.shã®å®Ÿè¡Œè¨­å®šã‚’æ¨å¥¨ã—ã¾ã™"
                    fi

                    # remoteUserãƒã‚§ãƒƒã‚¯
                    local remote_user
                    remote_user=$(echo "$cleaned_json" | jq -r '.remoteUser // empty' 2>/dev/null)
                    if [[ -n "$remote_user" ]]; then
                        log_check "OK" "  ãƒªãƒ¢ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼: $remote_user"
                    else
                        log_check "WARNING" "  ãƒªãƒ¢ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                    fi

                else
                    log_check "WARNING" "devcontainer.json ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
                    echo "   JSONCãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆä»˜ãJSONï¼‰ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ãŒã€æ§‹æ–‡ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
                fi
            else
                log_check "WARNING" "jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€JSONæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"
            fi
        else
            log_check "ERROR" "devcontainer.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "   'vibebox init' ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã‹ã€æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„"
        fi

        # æ¨å¥¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
        local optional_scripts=(
            "hooks-post-start.sh"
            "ecr-login.sh"
        )

        for script in "${optional_scripts[@]}"; do
            if [[ -f "$PROJECT_ROOT/.devcontainer/$script" ]]; then
                log_check "OK" "devcontainerã‚¹ã‚¯ãƒªãƒ—ãƒˆ: $script"

                # å®Ÿè¡Œæ¨©é™ãƒã‚§ãƒƒã‚¯
                if [[ -x "$PROJECT_ROOT/.devcontainer/$script" ]]; then
                    log_check "OK" "å®Ÿè¡Œæ¨©é™: $script"
                else
                    log_check "WARNING" "å®Ÿè¡Œæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“: $script"
                    echo "   chmod +x .devcontainer/$script ã§æ¨©é™ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„"
                fi
            else
                log_check "WARNING" "æ¨å¥¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $script"
                echo "   ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯åˆæœŸåŒ–å‡¦ç†ã§ä½¿ç”¨ã•ã‚Œã¾ã™"
            fi
        done

    else
        log_check "ERROR" ".devcontainerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        echo "   'vibebox init' ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„"
    fi

    echo
    echo "â–  ä¾å­˜ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯"
    echo

    # Docker
    if command -v docker &> /dev/null; then
        if docker info >/dev/null 2>&1; then
            local docker_version
            docker_version=$(docker --version | grep -o 'Docker version [0-9.]*' | cut -d' ' -f3)
            log_check "OK" "Docker ($docker_version) - ç¨¼åƒä¸­"
        else
            log_check "ERROR" "DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ãŒã€ç¨¼åƒã—ã¦ã„ã¾ã›ã‚“"
            echo "   Docker Desktopã‚’èµ·å‹•ã™ã‚‹ã‹ã€Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„"
        fi
    else
        log_check "ERROR" "DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "   https://www.docker.com/get-started ã‹ã‚‰Dockerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    fi

    # devcontainer CLI
    if command -v devcontainer &> /dev/null; then
        local devcontainer_version
        devcontainer_version=$(devcontainer --version 2>/dev/null | head -1)
        log_check "OK" "devcontainer CLI ($devcontainer_version)"
    else
        log_check "ERROR" "devcontainer CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "   npm install -g @devcontainers/cli ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    fi

    # jq
    if command -v jq &> /dev/null; then
        local jq_version
        jq_version=$(jq --version 2>/dev/null)
        log_check "OK" "jq ($jq_version)"
    else
        log_check "ERROR" "jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "   brew install jq ã¾ãŸã¯ apt-get install jq ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    fi

    # tmux (æ¨å¥¨)
    if command -v tmux &> /dev/null; then
        local tmux_version
        tmux_version=$(tmux -V 2>/dev/null)
        log_check "OK" "tmux ($tmux_version) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«ä½¿ç”¨"
    else
        log_check "WARNING" "tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ¨å¥¨ï¼‰"
        echo "   brew install tmux ã¾ãŸã¯ apt-get install tmux ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨"
    fi

    # cursor (æ¨å¥¨)
    if command -v cursor &> /dev/null; then
        log_check "OK" "Cursor - ã‚¨ãƒ‡ã‚£ã‚¿é€£æºã«ä½¿ç”¨"
    else
        log_check "WARNING" "CursorãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ¨å¥¨ï¼‰"
        echo "   https://cursor.sh ã‹ã‚‰Cursorã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨"
    fi

    # gitè¨­å®šãƒã‚§ãƒƒã‚¯
    if command -v git &> /dev/null; then
        local git_version
        git_version=$(git --version | cut -d' ' -f3)
        log_check "OK" "Git ($git_version)"

        # gitè¨­å®šã®ç¢ºèª
        local git_user_name
        local git_user_email
        git_user_name=$(git config user.name 2>/dev/null)
        git_user_email=$(git config user.email 2>/dev/null)

        if [[ -n "$git_user_name" ]]; then
            log_check "OK" "Git user.name: $git_user_name"
        else
            log_check "WARNING" "Git user.name ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "   git config --global user.name 'Your Name' ã§è¨­å®šã—ã¦ãã ã•ã„"
        fi

        if [[ -n "$git_user_email" ]]; then
            log_check "OK" "Git user.email: $git_user_email"
        else
            log_check "WARNING" "Git user.email ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "   git config --global user.email 'your.email@example.com' ã§è¨­å®šã—ã¦ãã ã•ã„"
        fi
    fi

    echo
    echo "â–  AWS/ECR è¨­å®šãƒã‚§ãƒƒã‚¯ï¼ˆpushæ©Ÿèƒ½ç”¨ï¼‰"
    echo

    # AWS CLI
    if command -v aws &> /dev/null; then
        local aws_version
        aws_version=$(aws --version 2>&1 | cut -d' ' -f1)
        log_check "OK" "AWS CLI ($aws_version)"

        # AWSèªè¨¼æƒ…å ±ã®ç¢ºèª
        if aws sts get-caller-identity >/dev/null 2>&1; then
            local aws_account
            aws_account=$(aws sts get-caller-identity --query Account --output text 2>/dev/null)
            log_check "OK" "AWSèªè¨¼æƒ…å ± (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: $aws_account)"
        else
            log_check "WARNING" "AWSèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "   aws configure ã§AWSèªè¨¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆECRãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å¿…è¦ï¼‰"
        fi

        # envchainç¢ºèª
        if command -v envchain &> /dev/null; then
            log_check "OK" "envchain - AWSèªè¨¼æƒ…å ±ç®¡ç†ã«ä½¿ç”¨"
        else
            log_check "WARNING" "envchainãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ¨å¥¨ï¼‰"
            echo "   brew install envchain ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨"
        fi
    else
        log_check "WARNING" "AWS CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "   ECRãƒ—ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ AWS CLI ãŒå¿…è¦ã§ã™"
        echo "   https://aws.amazon.com/cli/ ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    fi

    echo
    echo "â–  æ¨©é™ãƒ»è¨­å®šãƒã‚§ãƒƒã‚¯"
    echo

    # ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒdockerã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã—ã¦ã„ã‚‹ã‹ï¼ˆLinuxï¼‰
    if [[ "$(uname)" != "Darwin" ]]; then
        if groups | grep -q docker; then
            log_check "OK" "Dockerã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—"
        else
            log_check "WARNING" "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒdockerã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã—ã¦ã„ã¾ã›ã‚“"
            echo "   sudo usermod -aG docker \$USER ã§ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã€å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"
        fi
    fi

    # HOME/.claude ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆdevcontainerãƒã‚¦ãƒ³ãƒˆç”¨ï¼‰
    if [[ -d "$HOME/.claude" ]]; then
        log_check "OK" "Claudeè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $HOME/.claude"
    else
        log_check "WARNING" "Claudeè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $HOME/.claude"
        echo "   Claude Desktopä½¿ç”¨æ™‚ã«è¨­å®šãŒå¼•ãç¶™ãŒã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    fi

    # .env ãƒ•ã‚¡ã‚¤ãƒ«
    if [[ -f "$PROJECT_ROOT/.env" ]]; then
        log_check "OK" ".envãƒ•ã‚¡ã‚¤ãƒ«"
    else
        log_check "WARNING" ".envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo "   ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ãªå ´åˆã¯ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"
    fi

    echo
    echo "â–  æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ³"
    echo

    # æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
    local workspace_dir="$PROJECT_ROOT/.vibebox-workspaces"
    if [[ -d "$workspace_dir" ]]; then
        local workspace_count
        workspace_count=$(find "$workspace_dir" -maxdepth 1 -type d | wc -l)
        workspace_count=$((workspace_count - 1)) # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè‡ªä½“ã‚’é™¤ã

        if [[ $workspace_count -gt 0 ]]; then
            log_check "OK" "æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: $workspace_count å€‹"
            echo "   '$0 list' ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™"
        else
            log_check "OK" "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆç©ºï¼‰"
        fi
    else
        log_check "OK" "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãªã—ï¼ˆåˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼‰"
    fi

    # ç¨¼åƒä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠ
    if command -v docker &> /dev/null && docker info >/dev/null 2>&1; then
        local git_repo_name
        git_repo_name=$(basename "$PROJECT_ROOT" 2>/dev/null)

        if [[ -n "$git_repo_name" ]]; then
            local running_containers
            running_containers=$(docker ps --filter "name=vibebox.${git_repo_name}" --format "{{.ID}}" 2>/dev/null | wc -l)

            if [[ $running_containers -gt 0 ]]; then
                log_check "OK" "ç¨¼åƒä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠ: $running_containers å€‹"
                echo "   '$0 list' ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™"
            else
                log_check "OK" "ç¨¼åƒä¸­ã®vibeboxã‚³ãƒ³ãƒ†ãƒŠãªã—"
            fi
        fi
    fi

    echo
    echo "=== è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼ ==="
    echo

    case "$overall_status" in
        "OK")
            echo "ğŸ‰ ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚vibeboxã‚’ä½¿ç”¨ã™ã‚‹æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚"
            ;;
        "WARNING")
            echo "âš ï¸  $warning_count å€‹ã®è­¦å‘ŠãŒã‚ã‚Šã¾ã™ã€‚åŸºæœ¬æ©Ÿèƒ½ã¯ä½¿ç”¨ã§ãã¾ã™ãŒã€ä¸€éƒ¨æ©Ÿèƒ½ã§åˆ¶é™ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            ;;
        "ERROR")
            echo "âŒ $error_count å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚vibeboxã‚’æ­£å¸¸ã«ä½¿ç”¨ã™ã‚‹ã«ã¯ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
            ;;
    esac

    if [[ $warning_count -gt 0 || $error_count -gt 0 ]]; then
        echo
        echo "æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
        if [[ $error_count -gt 0 ]]; then
            echo "1. ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼é …ç›®ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"
            echo "2. ä¿®æ­£å¾Œã€'$0 doctor' ã‚’å†å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        if [[ $warning_count -gt 0 ]]; then
            echo "1. è­¦å‘Šé …ç›®ã®ä¿®æ­£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ï¼ˆæ©Ÿèƒ½å‘ä¸Šã®ãŸã‚ï¼‰"
        fi
        echo "3. å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€'$0 init' ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
    else
        echo
        echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
        echo "1. '$0 container build' - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰"
        echo "2. '$0 up <branch-name>' - é–‹ç™ºã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹"
    fi

    echo
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    # å¼•æ•°ãŒãªã„å ´åˆã¯ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
    if [[ $# -eq 0 ]]; then
        show_usage
        exit 1
    fi

    case "$1" in
        init)
            shift

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            init_vibebox
            ;;
        container)
            if [[ "$2" != "build" && "$2" != "tag" && "$2" != "push" ]]; then
                echo "ã‚¨ãƒ©ãƒ¼: 'container' ã‚³ãƒãƒ³ãƒ‰ã«ã¯ 'build'ã€'tag'ã€ã¾ãŸã¯ 'push' ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ãŒå¿…è¦ã§ã™" >&2
                show_usage
                exit 1
            fi
            local subcommand="$2"
            shift 2

            case "$subcommand" in
                build)
                    local custom_tag=""
                    local use_aws_env="false"
                    local no_cache="false"
                    local custom_build_args=()

                    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --tag)
                                custom_tag="$2"
                                shift 2
                                ;;
                            --build-arg)
                                custom_build_args+=(--build-arg "$2")
                                shift 2
                                ;;
                            --no-cache)
                                no_cache="true"
                                shift
                                ;;
                            --help|-h)
                                show_usage
                                exit 0
                                ;;
                            *)
                                echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                                show_usage
                                exit 1
                                ;;
                        esac
                    done

                    # ã‚¿ã‚°ã‚’æ±ºå®š
                    if [[ -n "$custom_tag" ]]; then
                        TAG="$custom_tag"
                    fi

                    build_image "$TAG" "$use_aws_env" "$no_cache" "${custom_build_args[@]}"
                    ;;
                tag)
                    container_tag_command "$@"
                    ;;
                push)
                    local custom_tag=""

                    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --tag)
                                custom_tag="$2"
                                shift 2
                                ;;
                            --help|-h)
                                show_usage
                                exit 0
                                ;;
                            *)
                                echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                                show_usage
                                exit 1
                                ;;
                        esac
                    done

                    # ã‚¿ã‚°ã‚’æ±ºå®š
                    if [[ -n "$custom_tag" ]]; then
                        TAG="$custom_tag"
                    fi

                    push_image "$TAG"
                    ;;
            esac
            ;;
        up|open)
            shift
            local branch_name=""
            local attach_flag="true"

            # æœ€åˆã®å¼•æ•°ãŒãƒ–ãƒ©ãƒ³ãƒå
            if [[ $# -gt 0 && "$1" != --* ]]; then
                branch_name="$1"
                shift
            fi

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --no-attach)
                        attach_flag="false"
                        shift
                        ;;
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            # ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if [[ -z "$branch_name" ]]; then
                echo "ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåã¯å¿…é ˆã§ã™" >&2
                show_usage
                exit 1
            fi

            start_session "$branch_name" "$attach_flag"
            ;;
        list|ls)
            shift

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            # ã“ã‚Œã¾ã§ã® listï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ï¼‰ã¯å»ƒæ­¢ã—ã€
            # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸€è¦§ï¼ˆws lsï¼‰ã«å§”è­²ã—ã¾ã™ã€‚
            list_workspaces
            ;;
        attach)
            shift
            local branch_name=""

            # æœ€åˆã®å¼•æ•°ãŒãƒ–ãƒ©ãƒ³ãƒå
            if [[ $# -gt 0 && "$1" != --* ]]; then
                branch_name="$1"
                shift
            fi

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            # ãƒ–ãƒ©ãƒ³ãƒåã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšattach_sessionã‚’å‘¼ã³å‡ºã™
            attach_session "$branch_name"
            ;;
        down|close)
            shift
            local branch_name=""
            local stop_all="false"
            local remove_workspace="false"

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --all)
                        stop_all="true"
                        shift
                        ;;
                    --rm)
                        remove_workspace="true"
                        shift
                        ;;
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
                        if [[ -z "$branch_name" ]]; then
                            branch_name="$1"
                            shift
                        else
                            echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                            show_usage
                            exit 1
                        fi
                        ;;
                esac
            done

            # --allã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆ
            if [[ "$stop_all" == "true" ]]; then
                stop_all_sessions "$remove_workspace"
            else
                # ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚ã€stop_sessionå†…ã§è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
                stop_session "$branch_name" "$remove_workspace"
            fi
            ;;
        shell)
            shift
            local branch_name=""

            # æœ€åˆã®å¼•æ•°ãŒãƒ–ãƒ©ãƒ³ãƒå
            if [[ $# -gt 0 && "$1" != --* ]]; then
                branch_name="$1"
                shift
            fi

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            # ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚ã€shell_sessionå†…ã§è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
            shell_session "$branch_name"
            ;;
        edit)
            shift
            local branch_name=""

            # æœ€åˆã®å¼•æ•°ãŒãƒ–ãƒ©ãƒ³ãƒå
            if [[ $# -gt 0 && "$1" != --* ]]; then
                branch_name="$1"
                shift
            fi

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            # ãƒ–ãƒ©ãƒ³ãƒåãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚ã€edit_sessionå†…ã§è‡ªå‹•å–å¾—ã‚’è©¦è¡Œ
            edit_session "$branch_name"
            ;;
        cd)
            shift
            local branch_name=""

            if [[ $# -gt 0 && "$1" != --* ]]; then
                branch_name="$1"
                shift
            fi

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            cd_local_session "$branch_name"
            ;;
        cleanup)
            shift

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            cleanup_worktrees
            ;;
        link)
            shift

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            link_vibebox_command
            ;;
        doctor)
            shift

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            doctor_check
            ;;
        workspace|ws)
            if [[ "$2" != "list" && "$2" != "ls" ]]; then
                echo "ã‚¨ãƒ©ãƒ¼: 'workspace' ã‚³ãƒãƒ³ãƒ‰ã«ã¯ 'list' ã¾ãŸã¯ 'ls' ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ãŒå¿…è¦ã§ã™" >&2
                show_usage
                exit 1
            fi
            local subcommand="$2"
            shift 2

            case "$subcommand" in
                list|ls)
                    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --help|-h)
                                show_usage
                                exit 0
                                ;;
                            *)
                                echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                                show_usage
                                exit 1
                                ;;
                        esac
                    done

                    list_workspaces
                    ;;
            esac
            ;;
        secrets)
            if [[ "$2" != "set" ]]; then
                echo "ã‚¨ãƒ©ãƒ¼: 'secrets' ã‚³ãƒãƒ³ãƒ‰ã«ã¯ 'set' ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ãŒå¿…è¦ã§ã™" >&2
                show_usage
                exit 1
            fi
            shift 2

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            secrets_set
            ;;
        rm)
            shift
            local branch_name=""

            # æœ€åˆã®å¼•æ•°ãŒãƒ–ãƒ©ãƒ³ãƒå
            if [[ $# -gt 0 && "$1" != --* ]]; then
                branch_name="$1"
                shift
            fi

            # ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --help|-h)
                        show_usage
                        exit 0
                        ;;
                    *)
                        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
                        show_usage
                        exit 1
                        ;;
                esac
            done

            remove_workspace "$branch_name"
            ;;
        help|--help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $1" >&2
            show_usage
            exit 1
            ;;
    esac
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿mainé–¢æ•°ã‚’å‘¼ã³å‡ºã—
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
